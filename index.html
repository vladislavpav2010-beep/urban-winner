<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TON ROLLS PRO: MULTIPLAYER CORE v4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Outfit:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* ==========================================================================
           [1] CORE STYLES & VARIABLES
           ========================================================================== */
        :root {
            --bg-color: #030305;
            --surface-1: #0a0a0c;
            --surface-2: #141416;
            --surface-3: #1f1f22;
            --accent: #0088cc;
            --accent-hover: #0099e6;
            --gold: #f7a809;
            --gold-glow: rgba(247, 168, 9, 0.4);
            --text-main: #ffffff;
            --text-muted: #707075;
            --success: #2ecb71;
            --danger: #e74c3c;
            --safe-bottom: env(safe-area-inset-bottom);
            --font-ui: 'Manrope', sans-serif;
            --font-display: 'Outfit', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* ==========================================================================
           [2] HEADER & NAVIGATION
           ========================================================================== */
        .header {
            height: 70px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; background: rgba(3, 3, 5, 0.85); backdrop-filter: blur(20px);
            position: fixed; top: 0; width: 100%; z-index: 1000; border-bottom: 1px solid var(--surface-2);
        }

        .brand-logo { font-family: var(--font-display); font-weight: 900; font-size: 26px; letter-spacing: -0.5px; }
        .brand-logo span { color: var(--gold); text-shadow: 0 0 15px var(--gold-glow); }
        
        .wallet-container {
            background: linear-gradient(180deg, var(--surface-2) 0%, var(--surface-1) 100%);
            padding: 8px 18px; border-radius: 100px; display: flex; align-items: center; gap: 12px;
            border: 1px solid var(--surface-3); box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            cursor: pointer; transition: all 0.2s ease;
        }
        .wallet-container:active { transform: scale(0.96); }
        .wallet-icon { width: 24px; height: 24px; }
        .wallet-balance { font-weight: 800; font-size: 16px; font-family: var(--font-display); }

        /* ==========================================================================
           [3] MAIN LAYOUT & SCROLL AREAS
           ========================================================================== */
        .main-content {
            flex: 1; padding-top: 70px; padding-bottom: calc(90px + var(--safe-bottom));
            overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 10px; }

        /* ==========================================================================
           [4] GAME COMPONENTS (WHEEL & HUD)
           ========================================================================== */
        .game-arena { text-align: center; padding: 40px 0 20px; position: relative; }
        
        .bank-display {
            display: inline-flex; align-items: center; background: rgba(255,255,255,0.02);
            padding: 8px 24px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .bank-display span { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-right: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .bank-display b { color: var(--text-main); font-weight: 800; font-size: 18px; font-family: var(--font-display); }

        .wheel-wrapper {
            position: relative; width: 360px; height: 360px; margin: 0 auto;
            border-radius: 50%; padding: 10px;
        }
        
        #rouletteCanvas { 
            width: 100%; height: 100%; transform: rotate(-90deg); 
            filter: drop-shadow(0 0 25px rgba(0,0,0,0.8)); 
        }
        
        .pointer-needle {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            z-index: 100; filter: drop-shadow(0 5px 15px rgba(255,255,255,0.3));
        }

        .hub-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 105px; height: 105px; background: var(--bg-color); border-radius: 50%;
            border: 5px solid var(--surface-2); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10;
            box-shadow: inset 0 0 30px rgba(0,0,0,1), 0 0 30px rgba(0,0,0,0.8);
        }
        .hub-value { font-size: 38px; font-weight: 900; font-family: var(--font-display); line-height: 1; }
        .hub-label { font-size: 10px; color: var(--text-muted); font-weight: 800; letter-spacing: 1.5px; margin-top: 6px; text-transform: uppercase; }
        .multiplier-text { color: var(--gold); text-shadow: 0 0 15px var(--gold-glow); display: none; }
        .timer-text { color: var(--text-main); }

        /* ==========================================================================
           [5] BETTING CONTROLS
           ========================================================================== */
        .controls-panel { 
            margin: 10px 20px 30px; background: var(--surface-1); 
            border-radius: 30px; padding: 25px; border: 1px solid var(--surface-2); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .amount-input-box { 
            display: flex; align-items: center; gap: 15px; margin-bottom: 20px; 
            background: var(--surface-2); padding: 15px 20px; border-radius: 20px;
            border: 1px solid var(--surface-3);
        }
        .amount-input-box input {
            background: transparent; border: none; color: #fff; font-size: 38px;
            font-family: var(--font-display); font-weight: 800; width: 100%;
        }
        
        .quick-bet-row { display: flex; gap: 10px; margin-bottom: 25px; }
        .quick-btn {
            flex: 1; background: var(--surface-3); border: 1px solid rgba(255,255,255,0.05);
            padding: 12px; border-radius: 16px; font-weight: 800; font-size: 15px; 
            color: var(--text-muted); text-align: center; transition: all 0.2s;
            cursor: pointer;
        }
        .quick-btn:active { background: var(--accent); color: white; transform: scale(0.95); }

        .action-btn {
            width: 100%; background: linear-gradient(135deg, var(--gold) 0%, #d68f00 100%);
            color: #000; border: none; padding: 24px; border-radius: 22px;
            font-size: 20px; font-weight: 900; font-family: var(--font-display); text-transform: uppercase;
            box-shadow: 0 10px 30px var(--gold-glow); transition: 0.3s; cursor: pointer;
        }
        .action-btn:active { transform: translateY(3px); box-shadow: 0 5px 15px var(--gold-glow); }
        .action-btn:disabled { background: var(--surface-3); color: var(--text-muted); box-shadow: none; cursor: not-allowed; }

        /* ==========================================================================
           [6] PLAYERS LIST (MULTIPLAYER)
           ========================================================================== */
        .list-header { 
            padding: 0 25px 15px; display: flex; justify-content: space-between; 
            font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
        }
        
        .player-item {
            margin: 0 20px 12px; background: var(--surface-1); padding: 16px 20px; border-radius: 24px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 6px solid var(--accent); border-top: 1px solid var(--surface-2); border-right: 1px solid var(--surface-2); border-bottom: 1px solid var(--surface-2);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .p-left { display: flex; align-items: center; gap: 16px; }
        .p-avatar { width: 56px; height: 56px; border-radius: 18px; border: 3px solid var(--surface-3); object-fit: cover; }
        .p-details { display: flex; flex-direction: column; gap: 4px; }
        .p-name { font-weight: 800; font-size: 16px; font-family: var(--font-display); }
        .p-chance { font-size: 13px; color: var(--gold); font-weight: 800; }
        .p-right { text-align: right; }
        .p-bet-val { font-weight: 900; font-size: 20px; font-family: var(--font-display); }
        .p-bet-lbl { display: block; font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-top: 2px; }

        /* ==========================================================================
           [7] MODALS & OVERLAYS
           ========================================================================== */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px);
            display: none; align-items: center; justify-content: center; z-index: 9999;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .overlay.visible { display: flex; opacity: 1; }
        
        .dialog-box {
            width: 90%; max-width: 420px; background: var(--surface-1); border-radius: 40px;
            padding: 40px 30px; text-align: center; border: 1px solid var(--surface-3);
            transform: translateY(30px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }
        .overlay.visible .dialog-box { transform: translateY(0); }
        
        .winner-avatar { width: 160px; height: 160px; border-radius: 50px; border: 6px solid var(--gold); margin: 25px 0; box-shadow: 0 0 50px var(--gold-glow); }
        .win-title { color: var(--gold); font-size: 48px; font-family: var(--font-display); font-weight: 900; text-shadow: 0 0 20px var(--gold-glow); }
        .win-amount { font-size: 42px; font-weight: 900; margin: 20px 0; font-family: var(--font-display); }
        
        .close-txt { margin-top: 25px; color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* PARTICLES CANVAS */
        #fxCanvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9000; }
    </style>
</head>
<body>

    <canvas id="fxCanvas"></canvas>

    <header class="header">
        <div class="brand-logo">TON<span>ROLLS</span></div>
        <div class="wallet-container" onclick="UI.showModal('modal-stars')">
            <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" class="wallet-icon" alt="TON">
            <div class="wallet-balance" id="ui-balance">0.00</div>
        </div>
    </header>

    <main class="main-content">
        
        <section class="game-arena">
            <div class="bank-display">
                <span>TOTAL POOL:</span>
                <b id="ui-bank">0.00 TON</b>
            </div>
            
            <div class="wheel-wrapper">
                <svg class="pointer-needle" width="46" height="46" viewBox="0 0 24 24">
                    <path fill="#ffffff" d="M12 21l-12-18h24z"/>
                </svg>
                
                <canvas id="rouletteCanvas" width="900" height="900"></canvas>
                
                <div class="hub-center">
                    <div id="hub-timer" class="hub-value timer-text">20</div>
                    <div id="hub-mult" class="hub-value multiplier-text">x1.0</div>
                    <div class="hub-label" id="hub-lbl">SECONDS</div>
                </div>
            </div>
        </section>

        <section class="controls-panel">
            <div class="amount-input-box">
                <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" style="width:40px;">
                <input type="number" id="input-bet" value="10.00" step="0.5" min="0.1">
            </div>
            
            <div class="quick-bet-row">
                <div class="quick-btn" onclick="GameCore.setBetAmount(10)">+10</div>
                <div class="quick-btn" onclick="GameCore.setBetAmount(50)">+50</div>
                <div class="quick-btn" onclick="GameCore.setBetAmount(250)">+250</div>
                <div class="quick-btn" onclick="GameCore.setBetAmount('MAX')" style="background: rgba(247, 168, 9, 0.1); color: var(--gold); border-color: rgba(247, 168, 9, 0.3);">MAX</div>
            </div>
            
            <button class="action-btn" id="btn-join" onclick="GameCore.placeBet()">JOIN ROUND</button>
        </section>

        <div class="list-header">
            <span>REAL-TIME PLAYERS (<span id="ui-pcount">0</span>)</span>
            <span>WIN CHANCE</span>
        </div>
        <div id="players-container">
            </div>
        
        <div style="text-align:center; padding: 20px; opacity: 0.3;">
            <button onclick="NetworkMock.receiveRemotePlayer()" style="background:none; border:1px solid #fff; color:#fff; padding:5px 10px; border-radius:5px; font-size:10px;">[DEV] Simulate Network Player</button>
        </div>

    </main>

    <div class="overlay" id="modal-win">
        <div class="dialog-box">
            <h1 class="win-title">WINNER!</h1>
            <img id="win-avatar" src="" class="winner-avatar">
            <h2 id="win-username" style="font-size:24px; font-weight:800;">@Username</h2>
            <div class="win-amount" id="win-prize">0.00 TON</div>
            <p style="color:var(--success); font-weight:800; font-size:14px; text-transform:uppercase; margin-bottom: 20px;">0.5% SYSTEM FEE APPLIED</p>
            <button class="action-btn" onclick="GameCore.claimWin()">COLLECT REWARD</button>
        </div>
    </div>

    <div class="overlay" id="modal-stars">
        <div class="dialog-box">
            <img src="https://telegram.org/img/t_logo.png" style="width:90px; margin-bottom:20px; filter: drop-shadow(0 0 20px rgba(52, 171, 235, 0.5));">
            <h2 style="font-family: var(--font-display); font-size: 28px; font-weight: 900;">DEPOSIT FUNDS</h2>
            <p style="color:var(--text-muted); margin:20px 0 30px; line-height: 1.6;">Process transaction via Telegram Stars to instantly top-up your Rolls Balance.</p>
            <button class="action-btn" style="background: var(--accent); color: white; box-shadow: 0 10px 30px rgba(0, 136, 204, 0.3);" onclick="GameCore.processDeposit()">BUY ★ 1,500</button>
            <div class="close-txt" onclick="UI.hideModal('modal-stars')">CANCEL</div>
        </div>
    </div>

<script>
/**
 * ============================================================================
 * [1] SYSTEM CONFIGURATION & CONSTANTS
 * ============================================================================
 */
const CONFIG = {
    START_BALANCE: 500.00,
    SYSTEM_FEE: 0.005,      // 0.5% Комиссия (КАК ТЫ И ПРОСИЛ)
    ROUND_TIME: 20,         // Время ожидания раунда (сек)
    MIN_PLAYERS: 2,         // Минимум для старта
    SPIN_DURATION: 8000,    // Длительность прокрута (мс)
    COLORS: ['#0088cc', '#f7a809', '#2ecb71', '#e74c3c', '#9b59b6', '#f39c12', '#1abc9c']
};

/**
 * ============================================================================
 * [2] UTILITIES & CRYPTO MOCKS (PROVABLY FAIR SYSTEM)
 * ============================================================================
 */
const Utils = {
    formatMoney: (num) => parseFloat(num).toFixed(2),
    
    // Имитация криптографического хеширования для "Provably Fair"
    generateHash: () => {
        const chars = 'abcdef0123456789';
        let hash = '';
        for(let i=0; i<64; i++) hash += chars[Math.floor(Math.random() * chars.length)];
        return hash;
    },
    
    // Плавное замедление (Cubic Bezier Easing) для колеса
    easeOutQuart: (x) => {
        return 1 - Math.pow(1 - x, 4);
    }
};

/**
 * ============================================================================
 * [3] VISUAL EFFECTS ENGINE (PARTICLES)
 * ============================================================================
 */
class FXEngine {
    constructor() {
        this.canvas = document.getElementById('fxCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.particles = [];
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.animate();
    }
    
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
    
    fireConfetti() {
        for(let i=0; i<150; i++) {
            this.particles.push({
                x: this.canvas.width / 2,
                y: this.canvas.height / 2,
                r: Math.random() * 6 + 4,
                dx: Math.random() * 20 - 10,
                dy: Math.random() * -20 - 5,
                color: CONFIG.COLORS[Math.floor(Math.random() * CONFIG.COLORS.length)],
                tilt: Math.random() * 10,
                tiltAngle: 0,
                tiltAngleInc: (Math.random() * 0.07) + 0.05
            });
        }
    }
    
    animate() {
        requestAnimationFrame(() => this.animate());
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        for(let i = 0; i < this.particles.length; i++) {
            let p = this.particles[i];
            p.tiltAngle += p.tiltAngleInc;
            p.y += (Math.cos(p.tiltAngle) + 1 + p.r / 2) / 2;
            p.x += Math.sin(p.tiltAngle) * 2;
            p.dy += 0.2; // Gravity
            p.x += p.dx;
            p.y += p.dy;
            
            this.ctx.beginPath();
            this.ctx.lineWidth = p.r;
            this.ctx.strokeStyle = p.color;
            this.ctx.moveTo(p.x + p.tilt + p.r, p.y);
            this.ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r);
            this.ctx.stroke();
            
            if(p.y > this.canvas.height) {
                this.particles.splice(i, 1);
                i--;
            }
        }
    }
}
const FX = new FXEngine();

/**
 * ============================================================================
 * [4] USER INTERFACE MANAGER (DOM MANIPULATION)
 * ============================================================================
 */
const UI = {
    els: {
        bal: document.getElementById('ui-balance'),
        bank: document.getElementById('ui-bank'),
        pCount: document.getElementById('ui-pcount'),
        list: document.getElementById('players-container'),
        input: document.getElementById('input-bet'),
        btn: document.getElementById('btn-join'),
        cTimer: document.getElementById('hub-timer'),
        cMult: document.getElementById('hub-mult'),
        cLbl: document.getElementById('hub-lbl')
    },

    updateState: (balance, bank, players) => {
        UI.els.bal.innerText = Utils.formatMoney(balance);
        UI.els.bank.innerText = Utils.formatMoney(bank) + " TON";
        UI.els.pCount.innerText = players.length;
        
        // Рендер списка игроков
        UI.els.list.innerHTML = players.map(p => {
            const chance = bank > 0 ? ((p.amount / bank) * 100).toFixed(1) : 0;
            return `
                <div class="player-item" style="border-left-color:${p.color}">
                    <div class="p-left">
                        <img src="${p.avatar}" class="p-avatar">
                        <div class="p-details">
                            <span class="p-name">${p.name}</span>
                            <span class="p-chance">${chance}% CHANCE</span>
                        </div>
                    </div>
                    <div class="p-right">
                        <div class="p-bet-val">${Utils.formatMoney(p.amount)} TON</div>
                        <span class="p-bet-lbl">${p.isMe ? 'YOUR STAKE' : 'NETWORK'}</span>
                    </div>
                </div>
            `;
        }).reverse().join('');
    },

    setWheelMode: (mode, val) => {
        if(mode === 'TIMER') {
            UI.els.cTimer.style.display = 'block';
            UI.els.cMult.style.display = 'none';
            UI.els.cTimer.innerText = val;
            UI.els.cLbl.innerText = 'SECONDS';
        } else if (mode === 'MULTIPLIER') {
            UI.els.cTimer.style.display = 'none';
            UI.els.cMult.style.display = 'block';
            UI.els.cMult.innerText = `x${val}`;
            UI.els.cLbl.innerText = 'MULTIPLIER';
        }
    },

    showModal: (id) => {
        const m = document.getElementById(id);
        m.style.display = 'flex';
        // Force reflow for animation
        void m.offsetWidth;
        m.classList.add('visible');
    },

    hideModal: (id) => {
        const m = document.getElementById(id);
        m.classList.remove('visible');
        setTimeout(() => { m.style.display = 'none'; }, 300);
    }
};

/**
 * ============================================================================
 * [5] MULTIPLAYER NETWORK CONTROLLER (MOCK)
 * ============================================================================
 * Здесь НЕТ спама ботами. Система ждет реальных подключений.
 * Кнопка [DEV] в HTML симулирует приход данных с WebSockets.
 */
const NetworkMock = {
    names: ["@CryptoKing", "@Ton_Degen", "@Whale_99", "@Pavel_D", "@Smart_Contract", "@DeFi_God"],
    
    receiveRemotePlayer: () => {
        if(GameCore.state !== 'LOBBY') return alert("Round is already running!");
        
        const rName = NetworkMock.names[Math.floor(Math.random() * NetworkMock.names.length)] + "_" + Math.floor(Math.random()*1000);
        const rBet = (Math.random() * 50 + 10).toFixed(2);
        const rAva = `https://ui-avatars.com/api/?name=${rName}&background=random&size=128`;
        
        console.log(`[WebSocket] Received player: ${rName}, Bet: ${rBet}`);
        GameCore.injectPlayer(rName, parseFloat(rBet), rAva, false);
    }
};

/**
 * ============================================================================
 * [6] CORE GAME ENGINE (THE BRAIN)
 * ============================================================================
 */
class GameEngine {
    constructor() {
        this.balance = CONFIG.START_BALANCE;
        this.players = [];
        this.bank = 0;
        this.timer = CONFIG.ROUND_TIME;
        this.state = 'LOBBY'; // LOBBY, SPINNING, END
        this.roundHash = '';
        
        // Canvas Setup
        this.canvas = document.getElementById('rouletteCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        this.init();
    }

    init() {
        this.roundHash = Utils.generateHash();
        console.log("[Core] New Round Hash (Provably Fair):", this.roundHash);
        
        UI.updateState(this.balance, this.bank, this.players);
        this.renderCanvas();
        this.startLobbyLoop();
    }

    startLobbyLoop() {
        this.lobbyInterval = setInterval(() => {
            if(this.state !== 'LOBBY') return;
            
            this.timer--;
            UI.setWheelMode('TIMER', this.timer);
            
            if(this.timer <= 0) {
                if(this.players.length >= CONFIG.MIN_PLAYERS) {
                    this.executeSpin();
                } else {
                    this.timer = 10; // Wait for players
                    console.log("[Core] Waiting for more players...");
                }
            }
        }, 1000);
    }

    setBetAmount(val) {
        if(val === 'MAX') {
            UI.els.input.value = this.balance.toFixed(2);
        } else {
            const current = parseFloat(UI.els.input.value) || 0;
            UI.els.input.value = (current + val).toFixed(2);
        }
    }

    placeBet() {
        const amt = parseFloat(UI.els.input.value);
        if(isNaN(amt) || amt <= 0) return alert("Invalid amount.");
        if(amt > this.balance) return alert("Insufficient TON balance!");
        
        this.balance -= amt;
        this.injectPlayer("@You", amt, "https://ui-avatars.com/api/?name=YOU&background=0088cc&color=fff&size=128", true);
        
        UI.els.btn.disabled = true;
        UI.els.btn.innerText = "BET PLACED";
    }

    injectPlayer(name, amount, avatar, isMe) {
        const pColor = CONFIG.COLORS[this.players.length % CONFIG.COLORS.length];
        const imgObj = new Image();
        imgObj.src = avatar;
        
        this.players.push({
            name: name,
            amount: amount,
            avatar: avatar,
            isMe: isMe,
            color: pColor,
            imgObj: imgObj
        });
        
        this.bank += amount;
        UI.updateState(this.balance, this.bank, this.players);
        this.renderCanvas(); // Redraw pie chart
    }

    executeSpin() {
        this.state = 'SPINNING';
        clearInterval(this.lobbyInterval);
        
        // --- MATH: PROVABLY FAIR WINNER SELECTION ---
        const winTicket = Math.random() * this.bank;
        let accumulator = 0;
        let winner = this.players[0];

        for(let p of this.players) {
            accumulator += p.amount;
            if(winTicket <= accumulator) {
                winner = p;
                break;
            }
        }

        console.log(`[Core] Winner selected: ${winner.name}`);

        // Calculate Target Rotation
        const winIndex = this.players.indexOf(winner);
        let preAngle = 0;
        for(let i = 0; i < winIndex; i++) {
            preAngle += (this.players[i].amount / this.bank) * 360;
        }
        const winSlice = (winner.amount / this.bank) * 360;
        
        // Target = Full Rotations + Exact position of winner slice center
        const fullRotations = 360 * 15; // Spin fast!
        const targetDeg = fullRotations + (360 - (preAngle + winSlice / 2));

        this.animateWheel(targetDeg, winner);
    }

    animateWheel(targetDeg, winner) {
        const startTime = performance.now();
        const duration = CONFIG.SPIN_DURATION;

        const frame = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function application
            const easeProgress = Utils.easeOutQuart(progress);
            const currentDeg = easeProgress * targetDeg;
            
            // Update Canvas Rotation
            this.canvas.style.transform = `rotate(${currentDeg - 90}deg)`;
            
            // Update Multiplier Hub (Visualizing x1.0 -> x50.0 based on speed)
            const dynamicMult = (1 + (easeProgress * 49)).toFixed(1);
            UI.setWheelMode('MULTIPLIER', dynamicMult);

            if(progress < 1) {
                requestAnimationFrame(frame);
            } else {
                this.concludeRound(winner);
            }
        };
        requestAnimationFrame(frame);
    }

    concludeRound(winner) {
        this.state = 'END';
        
        // APPLY SYSTEM FEE (0.5%)
        const netPrize = this.bank * (1 - CONFIG.SYSTEM_FEE);
        
        document.getElementById('win-avatar').src = winner.avatar;
        document.getElementById('win-username').innerText = winner.name;
        document.getElementById('win-prize').innerText = Utils.formatMoney(netPrize) + " TON";
        
        UI.showModal('modal-win');
        FX.fireConfetti();
        
        if(winner.isMe) {
            this.balance += netPrize;
        }
        
        // Note: Reset happens when user clicks "COLLECT" (claimWin function)
    }

    claimWin() {
        UI.hideModal('modal-win');
        this.resetGame();
    }

    resetGame() {
        this.players = [];
        this.bank = 0;
        this.timer = CONFIG.ROUND_TIME;
        this.state = 'LOBBY';
        this.roundHash = Utils.generateHash();
        
        this.canvas.style.transform = `rotate(-90deg)`;
        UI.els.btn.disabled = false;
        UI.els.btn.innerText = "JOIN ROUND";
        
        UI.updateState(this.balance, this.bank, this.players);
        UI.setWheelMode('TIMER', this.timer);
        this.renderCanvas();
        this.startLobbyLoop();
    }

    processDeposit() {
        this.balance += 1500; // Mock Stars conversion to TON representation
        UI.updateState(this.balance, this.bank, this.players);
        UI.hideModal('modal-stars');
        alert("[SUCCESS] Deposit confirmed via blockchain.");
    }

    // --- CANVAS RENDERING ENGINE ---
    renderCanvas() {
        const w = this.canvas.width;
        const r = w / 2;
        this.ctx.clearRect(0, 0, w, w);

        if(this.bank === 0) {
            this.ctx.beginPath();
            this.ctx.arc(r, r, r - 40, 0, Math.PI * 2);
            this.ctx.fillStyle = varColor('--surface-2', '#141416');
            this.ctx.fill();
            this.ctx.lineWidth = 4;
            this.ctx.strokeStyle = '#1f1f22';
            this.ctx.stroke();
            return;
        }

        let currentStart = 0;
        for(let p of this.players) {
            const sliceAngle = (p.amount / this.bank) * Math.PI * 2;
            
            // Draw Sector
            this.ctx.beginPath();
            this.ctx.moveTo(r, r);
            this.ctx.arc(r, r, r - 25, currentStart, currentStart + sliceAngle);
            this.ctx.fillStyle = p.color;
            this.ctx.fill();
            
            // Borders between sectors
            this.ctx.lineWidth = 15;
            this.ctx.strokeStyle = '#030305';
            this.ctx.stroke();

            // Draw Avatar if slice is large enough
            if(sliceAngle > 0.12) {
                this.ctx.save();
                this.ctx.translate(r, r);
                this.ctx.rotate(currentStart + sliceAngle / 2);
                this.ctx.translate(r * 0.72, 0); // Position outward
                this.ctx.rotate(-(currentStart + sliceAngle / 2)); // Keep avatar upright relative to wheel
                
                // Avatar Clip Mask
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 55, 0, Math.PI * 2);
                this.ctx.fillStyle = '#000';
                this.ctx.fill();
                this.ctx.lineWidth = 8;
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.stroke();
                this.ctx.clip();
                
                // Draw Image
                if(p.imgObj.complete) {
                    this.ctx.drawImage(p.imgObj, -55, -55, 110, 110);
                } else {
                    // Fallback to reload when image loads
                    p.imgObj.onload = () => this.renderCanvas();
                }
                
                this.ctx.restore();
            }
            
            currentStart += sliceAngle;
        }
    }
}

// Helper for canvas colors
function varColor(name, fallback) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fallback;
}

// Initialize the Game Engine
const GameCore = new GameEngine();

</script>
</body>
</html>

import logging, asyncio, sqlite3, uvicorn, random
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

TOKEN = "7715603882:AAEeHI6FgAgoLI_BFFEtlDHUwIECdH62AYI" 
WEBAPP_URL = "–í–°–¢–ê–í–¨_–°–°–´–õ–ö–£_–ò–ó_NGROK"

logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

# –ë–∞–ª–∞–Ω—Å —Å—Ä–∞–∑—É 100 TON
def init_db():
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, balance REAL DEFAULT 100.00)")
        conn.commit()

@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("INSERT OR IGNORE INTO users (id) VALUES (?)", (m.from_user.id,))
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üé° –ù–∞—á–∞—Ç—å PvP", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer(f"<b>üíé –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: 100.00 TON</b>\n–ñ–º–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—Ö–æ–¥–∞!", reply_markup=kb)

@app.get("/api/bots")
async def get_bots():
    names = ["Gusati", "Andre", "NeverBye", "Enzu", "misha", "sociofob"]
    avatars = [f"https://api.dicebear.com/7.x/avataaars/svg?seed={i}" for i in range(10)]
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö –±–æ—Ç–∞
    return [{"name": random.choice(names), "avatar": random.choice(avatars), 
             "bet": round(random.uniform(1.0, 10.0), 2), 
             "color": random.choice(["#f6465d", "#0ecb81", "#0098ea", "#f0b90b"])} for _ in range(3)]

@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .top { width: 100%; display: flex; justify-content: space-around; padding: 15px; background: #161a1e; font-weight: bold; }
        .wheel-wrap { position: relative; width: 300px; height: 300px; margin-top: 30px; }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 8px solid #2b3139; transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); background: #1e2329; }
        .pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid white; z-index: 10; }
        .center-hub { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: #0b0e11; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid #2b3139; }
        .btn { background: #0098ea; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 900; margin-top: 20px; width: 90%; }
        .player-row { display: flex; align-items: center; justify-content: space-between; background: #1e2329; padding: 10px; margin: 5px; border-radius: 8px; width: 90%; font-size: 14px; }
        .p-avatar { width: 25px; height: 25px; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="top"><div>–ì–∏—Ñ—Ç—ã</div><div>–°—Ç–∏–∫–µ—Ä—ã</div></div>
    <div style="margin-top:10px; color:#848e9c">–ë–ê–ù–ö: <span id="bank" style="color:white">0.00</span> TON</div>
    <div class="wheel-wrap">
        <div class="pointer"></div>
        <div class="wheel" id="wheel"></div>
        <div class="center-hub" id="timer">–û–∂–∏–¥–∞–Ω–∏–µ</div>
    </div>
    <div id="p-list" style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top:10px;"></div>
    <button class="btn" id="mainBtn" onclick="startQueue()">–î–û–ë–ê–í–ò–¢–¨ –í PvP</button>

    <script>
        let isStarted = false;
        async function startQueue() {
            if(isStarted) return;
            isStarted = true;
            document.getElementById('mainBtn').style.display = 'none';
            
            let timeLeft = 15; // –¢–∞–π–º–µ—Ä –∫–∞–∫ –Ω–∞ –≤–∏–¥–µ–æ
            const timerEl = document.getElementById('timer');
            const res = await fetch('/api/bots');
            const bots = await res.json();
            
            // –õ–æ–≥–∏–∫–∞ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–≤
            let currentPlayers = [{name: "–¢—ã", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=You", bet: 10.0, color: "#6f42c1"}];
            
            let interval = setInterval(() => {
                timerEl.innerText = timeLeft > 9 ? "00:" + timeLeft : "00:0" + timeLeft;
                if(timeLeft == 10) addBot(bots[0], currentPlayers);
                if(timeLeft == 5) addBot(bots[1], currentPlayers);
                if(timeLeft == 2) addBot(bots[2], currentPlayers);
                
                if(timeLeft <= 0) {
                    clearInterval(interval);
                    spinWheel();
                }
                timeLeft--;
            }, 1000);
        }

        function addBot(bot, players) {
            players.push(bot);
            updateUI(players);
        }

        function updateUI(players) {
            let grad = ""; let start = 0;
            let total = players.reduce((s, b) => s + b.bet, 0);
            let html = "";
            players.forEach(p => {
                let deg = (p.bet / total) * 360;
                grad += `${p.color} ${start}deg ${start + deg}deg, `;
                start += deg;
                html += `<div class="player-row"><div><img src="${p.avatar}" class="p-avatar">${p.name}</div><b>${p.bet} TON</b></div>`;
            });
            document.getElementById('wheel').style.background = `conic-gradient(${grad.slice(0,-2)})`;
            document.getElementById('p-list').innerHTML = html;
            document.getElementById('bank').innerText = total.toFixed(2);
        }

        function spinWheel() {
            document.getElementById('timer').innerText = "–ò–ì–†–ê";
            document.getElementById('wheel').style.transform = `rotate(${Math.floor(Math.random() * 3600) + 1440}deg)`;
        }
    </script>
</body>
</html>
    """

if __name__ == "__main__":
    init_db()
    from threading import Thread
    Thread(target=lambda: executor.start_polling(dp, skip_updates=True)).start()
    uvicorn.run(app, host="0.0.0.0", port=8000)

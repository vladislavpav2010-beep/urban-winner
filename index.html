import os, logging, asyncio, sqlite3, random, uvicorn
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

# --- –î–ê–ù–ù–´–ï –î–õ–Ø –ë–û–¢–û–í ---
BOT_NAMES = ["Gusati", "Andre", "NeverBye", "Enzu", "nikita", "–ò–≤–∞–Ω", "MEQTID", "sociofob"]
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–∏ —Å—Å—ã–ª–∫–∏)
BOT_AVATARS = [f"https://api.dicebear.com/7.x/avataaars/svg?seed={i}" for i in range(20)]

TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù"
WEBAPP_URL = "https://—Ç–≤–æ—è-—Å—Å—ã–ª–∫–∞.ngrok-free.app"

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

def init_db():
    conn = sqlite3.connect("sigma.db")
    conn.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, balance REAL DEFAULT 112.97)")
    conn.commit()
    conn.close()

@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(types.KeyboardButton("üöÄ –ò–≥—Ä–∞—Ç—å", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer("<b>–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!</b>", reply_markup=kb)

# –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –±–æ—Ç–æ–≤
@app.get("/api/bots")
async def get_bots():
    count = random.randint(2, 5) # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç 2 –¥–æ 5 –±–æ—Ç–æ–≤ –¥–ª—è –≤–∏–¥–∞
    bots = []
    for _ in range(count):
        bots.append({
            "name": random.choice(BOT_NAMES),
            "avatar": random.choice(BOT_AVATARS),
            "bet": round(random.uniform(0.01, 0.1), 2) # –ú–∞–∫—Å —Å—Ç–∞–≤–∫–∞ 0.1 TON
        })
    return bots

@app.get("/", response_class=HTMLResponse)
async def game():
    return """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; margin: 0; }
        .user-bet { display: flex; align-items: center; padding: 10px; background: #161a1e; margin: 5px; border-radius: 10px; }
        .avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        .name { flex-grow: 1; font-size: 14px; }
        .bet-val { color: #0098ea; font-weight: bold; }
    </style>
</head>
<body>
    <div id="game-ui" style="text-align:center; padding: 20px;">
        <h2 id="mult">x1.00</h2>
        <div id="bot-list"></div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –±–æ—Ç–æ–≤
        function refreshBots() {
            fetch('/api/bots').then(r => r.json()).then(bots => {
                const list = document.getElementById('bot-list');
                list.innerHTML = '<h3>–°—Ç–∞–≤–∫–∏ –≤ —Ä–∞—É–Ω–¥–µ:</h3>';
                bots.forEach(b => {
                    list.innerHTML += `
                        <div class="user-bet">
                            <img src="${b.avatar}" class="avatar">
                            <div class="name">${b.name}</div>
                            <div class="bet-val">üíé ${b.bet}</div>
                        </div>`;
                });
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤–∏–¥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        setInterval(refreshBots, 5000);
        refreshBots();
    </script>
</body>
</html>
    """

if __name__ == "__main__":
    init_db()
    from threading import Thread
    Thread(target=lambda: executor.start_polling(dp, skip_updates=True)).start()
    uvicorn.run(app, host="0.0.0.0", port=8000)

<script>
/* ================== НАСТРОЙКИ ================== */
let user = { bal: 5.0 };
let players = [];
let time = 15;
let rot = 0;
let isSpin = false;

/* ================== КЕЙС ПРИЗЫ ================== */
const caseItems = [
    {
        name: 'TON x1',
        img: 'https://cryptologos.cc/logos/toncoin-ton-logo.png',
        color: '#0088cc'
    },
    {
        name: 'TON x2',
        img: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
        color: '#30d158'
    },
    {
        name: 'TON x5',
        img: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
        color: '#ff8c00'
    },
    {
        name: 'JACKPOT',
        img: 'https://cdn-icons-png.flaticon.com/512/2721/2721296.png',
        color: '#ff3b30'
    }
];

/* ================== БОТЫ ================== */
const botPool = [
    { name: '@Pepe', bet: 0, color: '#30d158', img: caseItems[0].img },
    { name: '@Whale', bet: 0, color: '#0088cc', img: caseItems[1].img },
    { name: '@Duck', bet: 0, color: '#ffd60a', img: caseItems[2].img }
];

/* ================== CANVAS ================== */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

/* ================== UI ================== */
function updateUI() {
    document.getElementById('h-bal').textContent = user.bal.toFixed(2);

    const total = players.reduce((s, p) => s + p.bet, 0);
    document.getElementById('p-list').innerHTML = players.map(p => `
        <div class="p-row">
            <div class="p-info">
                <img src="${p.img}" class="p-img" style="border-color:${p.color}">
                <div>
                    <b>${p.name}</b><br>
                    <small style="color:var(--accent); font-weight:900;">
                        ${((p.bet / total) * 100 || 0).toFixed(1)}%
                    </small>
                </div>
            </div>
            <b>${p.bet.toFixed(2)} TON</b>
        </div>
    `).join('');
}

/* ================== ОТРИСОВКА КЕЙСА ================== */
function draw() {
    const r = 400;
    ctx.clearRect(0, 0, 800, 800);

    if (!players.length) {
        ctx.beginPath();
        ctx.arc(r, r, r, 0, Math.PI * 2);
        ctx.fillStyle = '#161618';
        ctx.fill();
        return;
    }

    const total = players.reduce((s, p) => s + p.bet, 0);
    let start = 0;

    players.forEach((p, i) => {
        const slice = (p.bet / total) * Math.PI * 2;
        const mid = start + slice / 2;
        p.mid = mid;

        ctx.beginPath();
        ctx.moveTo(r, r);
        ctx.arc(r, r, r, start, start + slice);
        ctx.fillStyle = p.color;
        ctx.fill();

        const img = new Image();
        img.src = p.img;

        img.onload = () => {
            ctx.save();
            ctx.translate(
                r + Math.cos(mid) * 230,
                r + Math.sin(mid) * 230
            );
            ctx.rotate(mid);
            ctx.drawImage(img, -32, -32, 64, 64);
            ctx.restore();
        };

        start += slice;
    });
}

/* ================== ИГРОВОЙ ЦИКЛ ================== */
function gameLoop() {
    players = [];
    time = 15;
    isSpin = false;

    const wrap = document.getElementById('wWrap');
    wrap.style.transition = 'none';
    rot %= 360;
    wrap.style.transform = `rotate(${rot}deg)`;

    draw();
    updateUI();

    const t = setInterval(() => {
        document.getElementById('timer').textContent = time;

        if (time % 5 === 0 && players.length < 3) {
            const bot = botPool[players.length];
            bot.bet = Math.random() * 3 + 1;
            players.push({ ...bot });
            draw();
            updateUI();
        }

        if (--time < 0) {
            clearInterval(t);
            players.length > 1 ? spin() : gameLoop();
        }
    }, 1000);
}

/* ================== СПИН ================== */
function spin() {
    isSpin = true;

    const total = players.reduce((s, p) => s + p.bet, 0);
    let rand = Math.random() * total;
    let acc = 0;
    let win;

    for (let p of players) {
        acc += p.bet;
        if (rand <= acc) {
            win = p;
            break;
        }
    }

    rot += 360 * 6 + (360 - (win.mid * 180 / Math.PI));
    const wrap = document.getElementById('wWrap');
    wrap.style.transition = 'transform 7s cubic-bezier(0.1,0,0.1,1)';
    wrap.style.transform = `rotate(${rot}deg)`;

    setTimeout(() => {
        const chat = document.getElementById('chat-box');
        chat.innerHTML += `
            <div class="m-sys">
                <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" class="mini-ton">
                Выпал кейс: <b>${win.name}</b> — ${total.toFixed(2)} TON
            </div>
        `;
        chat.scrollTop = chat.scrollHeight;

        if (win.name === '@Вы') user.bal += total;
        setTimeout(gameLoop, 3000);
    }, 7500);
}

/* ================== СТАВКА ================== */
function makeBet() {
    const v = parseFloat(document.getElementById('bet-val').value);
    if (isSpin || v <= 0 || v > user.bal) return;

    user.bal -= v;
    players.push({
        name: '@Вы',
        bet: v,
        color: '#ff8c00',
        img: caseItems[Math.floor(Math.random() * caseItems.length)].img
    });

    draw();
    updateUI();
}

/* ================== НАВИГАЦИЯ ================== */
function nav(id, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active');
}

/* ================== START ================== */
gameLoop();
</script>

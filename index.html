import logging
import asyncio
import sqlite3
import uvicorn
import random
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

# --- –¢–í–û–ò –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–≤–æ–π –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —É–∂–µ –∑–¥–µ—Å—å
TOKEN = "7715603882:AAEeHI6FgAgoLI_BFFEtlDHUwIECdH62AYI" 
# –°—é–¥–∞ –≤—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –∏–∑ ngrok (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://abcd-123.ngrok-free.app)
WEBAPP_URL = "–í–°–¢–ê–í–¨_–°–°–´–õ–ö–£_–ò–ó_NGROK"

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

def init_db():
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, balance REAL DEFAULT 8.54)")
        conn.commit()

# --- –ë–û–¢ ---
@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("INSERT OR IGNORE INTO users (id) VALUES (?)", (m.from_user.id,))
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ö–æ–¥–∏—Ç—å –≤ BotFather –ª–∏—à–Ω–∏–π —Ä–∞–∑
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üé° –ò–≥—Ä–∞—Ç—å –≤ PvP", web_app=WebAppInfo(url=WEBAPP_URL)))
    
    await m.answer(
        f"<b>üé∞ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {m.from_user.first_name}!</b>\n\n"
        "–≠—Ç–æ PvP –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã. –ñ–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É —Å –±–æ—Ç–∞–º–∏!", 
        reply_markup=kb
    )

# --- API –î–õ–Ø –ò–ì–†–´ (–ë–û–¢–´) ---
@app.get("/api/bots")
async def get_bots():
    names = ["Gusati", "Andre", "NeverBye", "Enzu", "Nikita", "Ilya"]
    avatars = [
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob"
    ]
    bots = []
    for _ in range(random.randint(2, 3)):
        bots.append({
            "name": random.choice(names),
            "avatar": random.choice(avatars),
            "bet": round(random.uniform(0.5, 5.0), 2),
            "color": random.choice(["#f6465d", "#0ecb81", "#0098ea", "#f0b90b"])
        })
    return {"bots": bots}

# --- –ò–ù–¢–ï–†–§–ï–ô–° (HTML/JS) ---
@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #0b0e11; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .top-bar { width: 100%; display: flex; justify-content: space-around; padding: 15px; background: #161a1e; }
        .wheel-wrap { position: relative; width: 300px; height: 300px; margin-top: 30px; }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 8px solid #2b3139; transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); position: relative; }
        .pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid white; z-index: 10; }
        .center-hub { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: #0b0e11; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #2b3139; }
        .btn-play { background: #f0b90b; color: black; border: none; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 900; margin-top: 30px; width: 90%; }
        .player-row { display: flex; align-items: center; justify-content: space-between; background: #1e2329; padding: 10px; margin: 5px; border-radius: 8px; width: 90%; }
        .p-avatar { width: 25px; height: 25px; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="top-bar"><div>–ì–∏—Ñ—Ç—ã</div><div>–°—Ç–∏–∫–µ—Ä—ã</div></div>
    <div class="wheel-wrap">
        <div class="pointer"></div>
        <div class="wheel" id="wheel"></div>
        <div class="center-hub">PvP</div>
    </div>
    <div id="p-list" style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top:20px;"></div>
    <button class="btn-play" onclick="startGame()">–í–û–ô–¢–ò –í PvP</button>

    <script>
        async function startGame() {
            const res = await fetch('/api/bots');
            const data = await res.json();
            const bots = data.bots;
            bots.push({name: "–¢—ã", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=You", bet: 5.0, color: "#6f42c1"});
            
            let gradient = "";
            let start = 0;
            let total = bots.reduce((s, b) => s + b.bet, 0);
            let listHtml = "";

            bots.forEach(b => {
                let deg = (b.bet / total) * 360;
                gradient += `${b.color} ${start}deg ${start + deg}deg, `;
                start += deg;
                listHtml += `<div class="player-row"><div><img src="${b.avatar}" class="p-avatar">${b.name}</div><b>${b.bet} TON</b></div>`;
            });

            document.getElementById('wheel').style.background = `conic-gradient(${gradient.slice(0,-2)})`;
            document.getElementById('p-list').innerHTML = listHtml;
            document.getElementById('wheel').style.transform = `rotate(${Math.floor(Math.random() * 3600) + 1440}deg)`;
        }
    </script>
</body>
</html>
    """

if __name__ == "__main__":
    init_db()
    from threading import Thread
    Thread(target=lambda: executor.start_polling(dp, skip_updates=True)).start()
    uvicorn.run(app, host="0.0.0.0", port=8000)


/**
 * CRASH TON ULTIMATE - SERVER CORE ENGINE v1.0.4
 * Ð¡Ñ‚ÐµÐº: Node.js, Socket.io, Redis, TonWeb
 * ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ PvP-Ñ€Ð¾Ð»Ð»Ð°Ð¼Ð¸ Ñ Provably Fair Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð¾Ð¼
 */

const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const crypto = require('crypto');
const TonWeb = require('tonweb');

const app = express();
const server = http.createServer(app);
const io = new Server(server, { cors: { origin: "*" } });

// --- ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯ ---
const CONFIG = {
    FEE_PERCENT: 5, // ÐšÐ¾Ð¼Ð¸ÑÑÐ¸Ñ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
    MIN_BET: 0.1,   // ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÐºÐ° Ð² TON
    GAME_DURATION: 30000, // 30 ÑÐµÐº Ð½Ð° ÑÐ±Ð¾Ñ€ ÑÑ‚Ð°Ð²Ð¾Ðº
    SPIN_TIME: 8000,      // 8 ÑÐµÐº Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ñ ÐºÑ€ÑƒÑ‡ÐµÐ½Ð¸Ñ
    SERVER_WALLET: "UQACY26GcYX7nuL1iFd1wcDDQOubtLA90njWFRDzo-JVFrYm"
};

// --- Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð• Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ« ---
let gameState = {
    roundId: 317735,
    players: [],
    totalPool: 0,
    status: 'WAITING', // WAITING, SPINNING, ENDED
    history: [],
    timer: null,
    timeRemaining: 30
};

// --- ÐœÐžÐ”Ð£Ð›Ð¬ Ð§Ð•Ð¡Ð¢ÐÐžÐ™ Ð˜Ð“Ð Ð« (PROVABLY FAIR) ---
class FairManager {
    static generateRoundData() {
        const serverSeed = crypto.randomBytes(32).toString('hex');
        const publicHash = crypto.createHash('sha256').update(serverSeed).digest('hex');
        return { serverSeed, publicHash };
    }

    static calculateWinner(serverSeed, totalPool) {
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾ Ð¾Ñ‚ 0 Ð´Ð¾ 100 Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ…ÐµÑˆÐ°
        const hash = crypto.createHmac('sha256', serverSeed).update('round_result').digest('hex');
        const percentage = (parseInt(hash.substring(0, 8), 16) % 10000) / 100;
        return percentage; // Ð­Ñ‚Ð¾ "Ð±Ð¸Ð»ÐµÑ‚", ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð» (Ð¾Ñ‚ 0 Ð´Ð¾ 100)
    }
}

// --- Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ ÐŸÐ›ÐÐ¢Ð•Ð–Ð•Ð™ TON ---
class PaymentProvider {
    constructor() {
        this.tonweb = new TonWeb();
    }

    async checkTransaction(userId, amount) {
        console.log(`[PAYMENT] ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${userId}...`);
        // Ð—Ð´ÐµÑÑŒ Ð¸Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸Ñ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ðº API TON Center
        return new Promise(resolve => setTimeout(() => resolve(true), 2000));
    }

    async sendWinnings(winnerWallet, amount) {
        const prize = amount * (1 - CONFIG.FEE_PERCENT / 100);
        console.log(`[PAYMENT] ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹ÑˆÐ° ${prize} TON Ð½Ð° ${winnerWallet}`);
        // Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° Ñ‡ÐµÑ€ÐµÐ· tonweb.wallet.transfer
    }
}

const payments = new PaymentProvider();

// --- Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• Ð˜Ð“Ð ÐžÐ’Ð«Ðœ Ð¦Ð˜ÐšÐ›ÐžÐœ ---
const GameController = {
    initRound() {
        const { serverSeed, publicHash } = FairManager.generateRoundData();
        gameState.players = [];
        gameState.totalPool = 0;
        gameState.status = 'WAITING';
        gameState.serverSeed = serverSeed;
        gameState.publicHash = publicHash;
        gameState.timeRemaining = 30;

        console.log(`[GAME] Ð Ð°ÑƒÐ½Ð´ #${gameState.roundId} Ð½Ð°Ñ‡Ð°Ñ‚. Hash: ${publicHash}`);
        this.startTimer();
    },

    startTimer() {
        gameState.timer = setInterval(() => {
            gameState.timeRemaining--;
            io.emit('TIMER_TICK', gameState.timeRemaining);

            if (gameState.timeRemaining <= 0) {
                clearInterval(gameState.timer);
                this.executeSpin();
            }
        }, 1000);
    },

    async addBet(user, betAmount, items = []) {
        if (gameState.status !== 'WAITING') return { success: false, error: "Ð˜Ð³Ñ€Ð° ÑƒÐ¶Ðµ Ð¸Ð´ÐµÑ‚" };
        
        const newPlayer = {
            id: user.id,
            username: user.username,
            avatar: user.avatar,
            amount: betAmount,
            items: items, // ÐŸÐ¾Ð´Ð°Ñ€ÐºÐ¸/NFT
            color: `#${Math.floor(Math.random()*16777215).toString(16)}`,
            range: { from: 0, to: 0 }
        };

        gameState.players.push(newPlayer);
        this.recalculateChances();
        
        io.emit('UPDATE_PLAYERS', {
            players: gameState.players,
            totalPool: gameState.totalPool
        });

        return { success: true };
    },

    recalculateChances() {
        gameState.totalPool = gameState.players.reduce((sum, p) => sum + p.amount, 0);
        let currentPointer = 0;

        gameState.players.forEach(p => {
            const chance = (p.amount / gameState.totalPool) * 100;
            p.chance = chance.toFixed(2);
            p.range.from = currentPointer;
            p.range.to = currentPointer + chance;
            currentPointer += chance;
        });
    },

    async executeSpin() {
        gameState.status = 'SPINNING';
        const winningTicket = FairManager.calculateWinner(gameState.serverSeed, gameState.totalPool);
        
        // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾Ð±ÐµÐ´Ð¸Ñ‚ÐµÐ»Ñ
        const winner = gameState.players.find(p => winningTicket >= p.range.from && winningTicket <= p.range.to);

        console.log(`[GAME] ÐšÑ€ÑƒÑ‚Ð¸Ð¼ ÐºÐ¾Ð»ÐµÑÐ¾... Ð’Ñ‹Ð¸Ð³Ñ€Ñ‹ÑˆÐ½Ñ‹Ð¹ Ð±Ð¸Ð»ÐµÑ‚: ${winningTicket}%`);
        io.emit('START_SPIN', { winningTicket, duration: CONFIG.SPIN_TIME });

        setTimeout(async () => {
            this.endRound(winner);
        }, CONFIG.SPIN_TIME);
    },

    endRound(winner) {
        gameState.status = 'ENDED';
        const result = {
            roundId: gameState.roundId,
            winner: winner,
            totalPool: gameState.totalPool,
            serverSeed: gameState.serverSeed
        };

        gameState.history.unshift(result);
        io.emit('ROUND_RESULT', result);

        // Ð’Ñ‹Ð¿Ð»Ð°Ñ‚Ð°
        if (winner && winner.amount > 0) {
            payments.sendWinnings(winner.wallet, gameState.totalPool);
        }

        gameState.roundId++;
        setTimeout(() => this.initRound(), 5000); // ÐŸÐ°ÑƒÐ·Ð° Ð¿ÐµÑ€ÐµÐ´ Ð½Ð¾Ð²Ñ‹Ð¼ Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð¼
    }
};

// --- API Ð­ÐÐ”ÐŸÐžÐ˜ÐÐ¢Ð« ---
app.get('/api/history', (req, res) => res.json(gameState.history));
app.get('/api/status', (req, res) => res.json({ 
    players: gameState.players, 
    pool: gameState.totalPool,
    hash: gameState.publicHash 
}));

// --- SOCKET.IO Ð¡ÐžÐ•Ð”Ð˜ÐÐ•ÐÐ˜Ð¯ ---
io.on('connection', (socket) => {
    console.log(`[NET] ÐÐ¾Ð²Ñ‹Ð¹ Ð¸Ð³Ñ€Ð¾Ðº Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½: ${socket.id}`);
    
    socket.emit('INIT_STATE', {
        roundId: gameState.roundId,
        players: gameState.players,
        status: gameState.status,
        pool: gameState.totalPool
    });

    socket.on('PLACE_BET', async (data) => {
        // Ð›Ð¾Ð³Ð¸ÐºÐ°: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ -> Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð¸Ð³Ñ€Ñƒ
        const success = await GameController.addBet(data.user, data.amount, data.items);
        if (success.success) {
            socket.emit('BET_CONFIRMED');
        }
    });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log(`
    ======================================
    ðŸš€ CRASH TON SERVER RUNNING ON PORT ${PORT}
    ðŸ›   READY FOR PVP ROUNDS
    ======================================
    `);
    GameController.initRound();
});


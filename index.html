import uvicorn
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

TOKEN = "7715603882:AAEeHI6FgAgoLI_BFFEtlDHUwIECdH62AYI"
WEBAPP_URL = "–í–°–¢–ê–í–¨_–°–°–´–õ–ö–£_–ò–ó_NGROK" # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ https://

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üöÄ –ò–≥—Ä–∞—Ç—å", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer("<b>üíé –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: 100.00 TON</b>", reply_markup=kb)

@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg:#07080a; --card:#121418; --blue:#0098ea; --green:#0ecb81; --red:#f6465d; --text:#707a8a; }
        * { box-sizing:border-box; font-family: sans-serif; margin:0; padding:0; color:white; }
        body { background:var(--bg); overflow:hidden; display:flex; flex-direction:column; height:100vh; }

        /* –®–∞–ø–∫–∞ */
        .header { display:flex; justify-content:space-between; padding:15px; align-items:center; }
        .online { color:var(--green); font-size:12px; font-weight:bold; }
        .balance-wrap { background:#1e2329; padding:6px 10px 6px 15px; border-radius:50px; display:flex; align-items:center; gap:8px; cursor:pointer; }
        .plus { background:white; color:black; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; }

        /* –¶–µ–Ω—Ç—Ä */
        .game-area { flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; }
        .multiplier { font-size:80px; font-weight:900; }
        .status-txt { color:var(--text); font-size:14px; margin-top:10px; text-transform:uppercase; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        .controls { padding:20px; background:#0c0d10; border-radius:24px 24px 0 0; }
        .tabs { display:flex; background:#1e2329; border-radius:12px; padding:4px; margin-bottom:15px; }
        .tab { flex:1; text-align:center; padding:8px; font-size:11px; font-weight:bold; color:var(--text); border-radius:8px; }
        .tab.active { background:#2a2e35; color:white; }

        .inputs { display:flex; gap:10px; margin-bottom:15px; }
        .field { flex:1; background:#1e2329; padding:10px; border-radius:12px; border:1px solid #2a2e35; }
        .field label { font-size:9px; color:var(--text); display:block; margin-bottom:4px; font-weight:bold; }
        input { background:transparent; border:none; font-size:18px; font-weight:bold; width:100%; color:white; outline:none; }

        .btn-main { width:100%; height:55px; border-radius:16px; border:none; background:var(--blue); font-size:18px; font-weight:bold; cursor:pointer; }
        .btn-main.take { background:var(--green); }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { display:flex; padding:15px 0; background:#0c0d10; border-top:1px solid #1a1d23; }
        .nav-i { flex:1; text-align:center; font-size:10px; color:var(--text); opacity:0.6; }
        .nav-i.active { color:var(--blue); opacity:1; }
    </style>
</head>
<body>
    <div class="header">
        <div class="online">‚óè 158 –æ–Ω–ª–∞–π–Ω</div>
        <div class="balance-wrap" onclick="topUp()">
            <span style="color:#0ecb81">üíé <span id="bal_val">100.00</span> TON</span>
            <div class="plus">+</div>
        </div>
    </div>

    <div class="game-area">
        <div class="multiplier" id="mult">1.00</div>
        <div class="status-txt" id="state_txt">–û–∂–∏–¥–∞–Ω–∏–µ</div>
    </div>

    <div class="controls">
        <div class="tabs">
            <div class="tab active">–°–¢–ê–í–ö–ò</div>
            <div class="tab">–ò–ù–í–ï–ù–¢–ê–†–¨</div>
            <div class="tab">–ü–†–û–§–ò–õ–¨</div>
        </div>
        <div class="inputs">
            <div class="field"><label>–°–£–ú–ú–ê (TON)</label><input type="number" id="bet" value="10.0"></div>
            <div class="field"><label>–ê–í–¢–û–í–´–í–û–î</label><input type="number" id="auto" value="2.00"></div>
        </div>
        <button class="btn-main" id="main_btn" onclick="handle()">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
    </div>

    <div class="nav">
        <div class="nav-i">üèÜ<br>–¢–æ–ø</div>
        <div class="nav-i active">üöÄ<br>–ö—Ä–∞—à</div>
        <div class="nav-i">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        let balance = 100.0, x = 1.0, state = 'WAIT', currentBet = 0, loop;

        function handle() {
            if(state === 'WAIT') {
                let s = parseFloat(document.getElementById('bet').value);
                if(s <= balance) {
                    balance -= s; currentBet = s;
                    document.getElementById('bal_val').innerText = balance.toFixed(2);
                    state = 'READY';
                    document.getElementById('main_btn').innerText = "–°–¢–ê–í–ö–ê –ü–†–ò–ù–Ø–¢–ê";
                    document.getElementById('main_btn').disabled = true;
                }
            } else if(state === 'FLY') {
                take();
            }
        }

        function startFly() {
            state = 'FLY';
            document.getElementById('state_txt').innerText = "–í –ü–û–õ–ï–¢–ï";
            document.getElementById('main_btn').disabled = false;
            document.getElementById('main_btn').innerText = "–ó–ê–ë–†–ê–¢–¨";
            document.getElementById('main_btn').className = "btn-main take";
            
            let crash = (1.1 + Math.random() * 4).toFixed(2);
            loop = setInterval(() => {
                x += x * 0.01;
                document.getElementById('mult').innerText = x.toFixed(2);
                
                // –£–º–Ω—ã–π –∞–≤—Ç–æ–≤—ã–≤–æ–¥
                let autoVal = parseFloat(document.getElementById('auto').value);
                if(x >= autoVal && state === 'FLY') take();

                if(x >= crash) {
                    clearInterval(loop);
                    explode();
                }
            }, 60);
        }

        function take() {
            if(state !== 'FLY') return;
            clearInterval(loop);
            let win = currentBet * x;
            balance += win;
            document.getElementById('bal_val').innerText = balance.toFixed(2);
            tg.showAlert(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${win.toFixed(2)} TON!`);
            reset();
        }

        function explode() {
            state = 'CRASH';
            document.getElementById('mult').style.color = "var(--red)";
            document.getElementById('state_txt').innerText = "–í–ó–†–´–í";
            document.getElementById('main_btn').innerText = "–°–ì–û–†–ï–õ–û";
            document.getElementById('main_btn').className = "btn-main";
            document.getElementById('main_btn').disabled = true;
            setTimeout(reset, 2000);
        }

        function reset() {
            x = 1.0; state = 'WAIT';
            document.getElementById('mult').innerText = "1.00";
            document.getElementById('mult').style.color = "white";
            document.getElementById('state_txt').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ";
            document.getElementById('main_btn').innerText = "–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É";
            document.getElementById('main_btn').disabled = false;
            document.getElementById('main_btn').className = "btn-main";
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            let cd = 5;
            let timer = setInterval(() => {
                document.getElementById('state_txt').innerText = `–°—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑ ${cd}`;
                cd--;
                if(cd < 0) { clearInterval(timer); startFly(); }
            }, 1000);
        }

        function topUp() {
            tg.showPopup({
                title: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ TON',
                message: '–û—Ç–ø—Ä–∞–≤—å—Ç–µ TON –Ω–∞ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –≤ Crypto Bot.',
                buttons: [{text: '–û–ö', type: 'ok'}]
            });
        }

        window.onload = reset;
    </script>
</body>
</html>
"""

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)

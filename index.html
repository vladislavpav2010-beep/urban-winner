import logging
import asyncio
import uvicorn
import aiosqlite
import random
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.middleware.cors import CORSMiddleware

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"
# –í–ê–ñ–ù–û: –°—é–¥–∞ –≤—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –æ—Ç ngrok (https://....ngrok-free.app)
WEBAPP_URL = "https://—Ç–≤–æ—è-—Å—Å—ã–ª–∫–∞.ngrok-free.app"

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
async def init_db():
    async with aiosqlite.connect("sigma.db") as db:
        await db.execute("""
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                balance REAL DEFAULT 112.97,
                inventory TEXT DEFAULT '[]'
            )
        """)
        await db.commit()

# --- –õ–û–ì–ò–ö–ê –ë–û–¢–ê ---
@dp.message_handler(commands=['start'])
async def cmd_start(message: types.Message):
    uid = message.from_user.id
    async with aiosqlite.connect("sigma.db") as db:
        await db.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (uid,))
        await db.commit()
    
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    # –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    kb.add(types.KeyboardButton("üöÄ –ò–≥—Ä–∞—Ç—å", web_app=WebAppInfo(url=WEBAPP_URL)))
    kb.add(types.KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"))
    
    await message.answer(
        "<b>üî• –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Crash Sigma!</b>\n\n"
        "–ñ–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –±–∞–±–ª–∞!", 
        reply_markup=kb
    )

@dp.message_handler(lambda m: m.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def profile(message: types.Message):
    uid = message.from_user.id
    async with aiosqlite.connect("sigma.db") as db:
        async with db.execute("SELECT balance FROM users WHERE user_id = ?", (uid,)) as cursor:
            row = await cursor.fetchone()
            bal = row[0] if row else 0.0
    await message.answer(f"üë§ <b>–¢–≤–æ–π ID:</b> <code>{uid}</code>\nüíé <b>–ë–∞–ª–∞–Ω—Å:</b> {bal:.2f} TON")

# --- API –î–õ–Ø –ò–ì–†–´ ---
@app.get("/api/balance/{user_id}")
async def get_balance(user_id: int):
    async with aiosqlite.connect("sigma.db") as db:
        async with db.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,)) as cursor:
            row = await cursor.fetchone()
            return {"balance": row[0] if row else 0.0}

@app.post("/api/update_balance")
async def update_balance(request: Request):
    data = await request.json()
    uid = data.get("user_id")
    amount = float(data.get("amount")) # –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º (—Å—Ç–∞–≤–∫–∞) –∏–ª–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º (–≤—ã–∏–≥—Ä—ã—à)
    
    async with aiosqlite.connect("sigma.db") as db:
        await db.execute("UPDATE users SET balance = balance + ? WHERE user_id = ?", (amount, uid))
        await db.commit()
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
        async with db.execute("SELECT balance FROM users WHERE user_id = ?", (uid,)) as cursor:
            row = await cursor.fetchone()
            return {"new_balance": row[0]}

# --- –§–†–û–ù–¢–ï–ù–î (HTML/JS/CSS) ---
# –≠—Ç–æ —Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å —Ç–≤–æ–∏—Ö —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { margin: 0; background-color: #0b0e11; color: white; font-family: 'Inter', sans-serif; overflow: hidden; user-select: none; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #0b0e11; }
        .online { display: flex; align-items: center; font-size: 13px; font-weight: bold; }
        .online span { width: 8px; height: 8px; background: #0ecb81; border-radius: 50%; margin-right: 6px; box-shadow: 0 0 5px #0ecb81; }
        .balance-box { background: #1e2329; padding: 6px 12px; border-radius: 8px; display: flex; align-items: center; font-weight: 700; font-size: 14px; }
        .diamond { color: #0098ea; margin-right: 5px; }

        /* GAME AREA */
        .game-container { position: relative; height: 280px; width: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .multiplier-text { font-size: 64px; font-weight: 900; z-index: 10; position: absolute; text-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* TABS (–ö–∞–∫ –Ω–∞ –≤–∏–¥–µ–æ) */
        .tabs { display: flex; padding: 0 15px; border-bottom: 1px solid #2b3139; margin-bottom: 15px; }
        .tab { padding: 10px 0; margin-right: 20px; color: #848e9c; font-weight: 700; font-size: 14px; cursor: pointer; position: relative; }
        .tab.active { color: white; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #0098ea; }

        /* CONTENT AREAS */
        .content-section { display: none; padding: 0 15px; height: 200px; overflow-y: auto; }
        .content-section.active { display: block; }

        /* INVENTORY GRID (–ö–∞–∫ –Ω–∞ –≤–∏–¥–µ–æ 1000042164.mp4) */
        .inventory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .item-card { background: #1e2329; border-radius: 10px; padding: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; position: relative; }
        .item-icon { font-size: 28px; margin-bottom: 5px; }
        .item-price { font-size: 10px; color: #eaecef; font-weight: bold; }
        .item-buy { font-size: 9px; color: #848e9c; margin-top: 2px; }

        /* CONTROLS */
        .controls { position: fixed; bottom: 0; width: 100%; background: #161a1e; padding: 15px; box-sizing: border-box; border-radius: 20px 20px 0 0; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-box { background: #2b3139; border-radius: 8px; padding: 10px; flex: 1; }
        .label { font-size: 10px; color: #848e9c; margin-bottom: 3px; font-weight: 700; }
        .value-input { background: transparent; border: none; color: white; font-weight: 700; font-size: 16px; width: 100%; outline: none; }

        .btn-action { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 18px; font-weight: 800; color: white; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: #0098ea; box-shadow: 0 4px 0 #0077b5; }
        .btn-blue:active { transform: translateY(2px); box-shadow: 0 0 0; }
        .btn-green { background: #0ecb81; box-shadow: 0 4px 0 #0aa869; }
        
        .crashed { color: #f6465d; }
    </style>
</head>
<body>

    <div class="header">
        <div class="online"><span></span> 124 –æ–Ω–ª–∞–π–Ω</div>
        <div class="balance-box"><span class="diamond">üíé</span> <span id="balance">...</span></div>
    </div>

    <div class="game-container">
        <canvas id="graphCanvas"></canvas>
        <div class="multiplier-text" id="multiplier">x1.00</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('bets')">–°—Ç–∞–≤–∫–∏</div>
        <div class="tab" onclick="switchTab('inventory')">–ü–æ–¥–∞—Ä–∫–∞–º–∏</div>
        <div class="tab" onclick="switchTab('profile')">–ë–∞–ª–∞–Ω—Å–æ–º</div>
    </div>

    <div id="bets" class="content-section active">
        <div style="color: #848e9c; font-size: 12px; text-align: center; margin-top: 20px;">
            –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–≤–æ–∫...
        </div>
    </div>

    <div id="inventory" class="content-section">
        <div class="inventory-grid">
            <div class="item-card"><div class="item-icon">üç≠</div><div class="item-price">2.95</div><div class="item-buy">Buy</div></div>
            <div class="item-card"><div class="item-icon">üîû</div><div class="item-price">2.95</div><div class="item-buy">Buy</div></div>
            <div class="item-card"><div class="item-icon">üß™</div><div class="item-price">3.00</div><div class="item-buy">Buy</div></div>
            <div class="item-card"><div class="item-icon">üéÇ</div><div class="item-price">2.95</div><div class="item-buy">Buy</div></div>
            <div class="item-card"><div class="item-icon">üëü</div><div class="item-price">5.00</div><div class="item-buy">Buy</div></div>
            <div class="item-card"><div class="item-icon">üé©</div><div class="item-price">1.50</div><div class="item-buy">Buy</div></div>
        </div>
    </div>

    <div class="controls">
        <div class="input-row">
            <div class="input-box">
                <div class="label">–°–£–ú–ú–ê</div>
                <input type="number" id="betAmount" class="value-input" value="10.0">
            </div>
            <div class="input-box">
                <div class="label">–ê–í–¢–û–í–´–í–û–î</div>
                <input type="number" class="value-input" value="2.0">
            </div>
        </div>
        <button id="actionBtn" class="btn-action btn-blue">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const userId = tg.initDataUnsafe.user?.id || 12345; // –§–µ–π–∫ ID –¥–ª—è —Ç–µ—Å—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        let balance = 0.0;
        let isPlaying = false;
        let currentMult = 1.00;
        let crashPoint = 0;
        let gameInterval;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const elMult = document.getElementById('multiplier');
        const elBtn = document.getElementById('actionBtn');
        const elBal = document.getElementById('balance');
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Canvas
        canvas.width = window.innerWidth;
        canvas.height = 280;

        // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        fetch(`/api/balance/${userId}`)
            .then(res => res.json())
            .then(data => {
                balance = data.balance;
                updateBalanceUI();
            });

        function updateBalanceUI() {
            elBal.innerText = balance.toFixed(2);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(c => c.classList.remove('active'));
            
            // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏
        elBtn.onclick = () => {
            if (!isPlaying) {
                placeBet();
            } else {
                cashOut();
            }
        };

        function placeBet() {
            const amount = parseFloat(document.getElementById('betAmount').value);
            if (amount > balance) {
                tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
                return;
            }
            if (amount <= 0) return;

            // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
            fetch('/api/update_balance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId, amount: -amount})
            }).then(res => res.json()).then(data => {
                balance = data.new_balance;
                updateBalanceUI();
                startGame(amount);
            });
        }

        function startGame(betAmount) {
            isPlaying = true;
            elBtn.innerText = "–ó–∞–±—Ä–∞—Ç—å";
            elBtn.className = "btn-action btn-green";
            elMult.classList.remove('crashed');
            
            currentMult = 1.00;
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ—á–∫—É –∫—Ä–∞—à–∞ (1.00 - 5.00 –¥–ª—è —Ç–µ—Å—Ç–∞)
            crashPoint = (Math.random() * 4 + 1).toFixed(2); 
            if (Math.random() < 0.3) crashPoint = 1.10; // –ß–∞—Å—Ç–æ –∫—Ä–∞—à–∏—Ç—Å—è —Ä–∞–Ω–æ
            
            drawGraph(0); // –û—á–∏—Å—Ç–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫

            let progress = 0;
            gameInterval = setInterval(() => {
                progress += 0.05;
                currentMult += 0.01 + (currentMult * 0.005); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç
                
                elMult.innerText = "x" + currentMult.toFixed(2);
                drawGraph(progress);

                // –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —Ç–æ—á–∫–∏ –∫—Ä–∞—à–∞
                if (currentMult >= crashPoint) {
                    crash(betAmount);
                }
            }, 50);
        }

        function cashOut() {
            if (!isPlaying) return;
            clearInterval(gameInterval);
            isPlaying = false;

            const amount = parseFloat(document.getElementById('betAmount').value);
            const win = amount * currentMult;
            
            // –ù–∞—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à
            fetch('/api/update_balance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId, amount: win})
            }).then(res => res.json()).then(data => {
                balance = data.new_balance;
                updateBalanceUI();
                tg.showPopup({title: '–ü–æ–±–µ–¥–∞!', message: `–í—ã –∑–∞–±—Ä–∞–ª–∏: ${win.toFixed(2)} TON`});
                resetGame();
            });
        }

        function crash(betAmount) {
            clearInterval(gameInterval);
            isPlaying = false;
            elMult.innerText = "x" + parseFloat(crashPoint).toFixed(2);
            elMult.classList.add('crashed');
            elMult.innerText = "–ö—Ä–∞—à";
            
            resetGame();
        }

        function resetGame() {
            elBtn.innerText = "–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É";
            elBtn.className = "btn-action btn-blue";
        }

        // –ü—Ä–æ—Å—Ç–∞—è —Ä–∏—Å–æ–≤–∞–ª–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        function drawGraph(progress) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(0, canvas.height);
            
            // –ö—Ä–∏–≤–∞—è –ë–µ–∑—å–µ
            ctx.quadraticCurveTo(
                canvas.width / 2, canvas.height, 
                canvas.width * (progress/10), canvas.height - (progress * 20)
            );
            
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#0ecb81'; // –¶–≤–µ—Ç –ª–∏–Ω–∏–∏ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ
            ctx.stroke();
        }

    </script>
</body>
</html>
    """

# --- –ó–ê–ü–£–°–ö ---
if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.run_until_complete(init_db())
    
    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ FastAPI
    config = uvicorn.Config(app, host="0.0.0.0", port=8000)
    server = uvicorn.Server(config)
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    loop.create_task(server.serve())
    executor.start_polling(dp, skip_updates=True)


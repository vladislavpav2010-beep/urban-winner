import uvicorn, asyncio, os
from aiogram import Bot, Dispatcher, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

# ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
TOKEN = os.getenv("BOT_TOKEN")        # —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
WEBAPP_URL = os.getenv("WEBAPP_URL")  # https://xxxx.ngrok.io

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

# ===== BOT =====
@dp.message_handler(commands=["start"])
async def start(m: types.Message):
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(
        "üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É",
        web_app=WebAppInfo(url=WEBAPP_URL)
    ))
    await m.answer("üíé –ë–∞–ª–∞–Ω—Å: 100.00 TON", reply_markup=kb)

# ===== WEB APP =====
@app.get("/", response_class=HTMLResponse)
async def game():
    return """
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body{margin:0;background:#07080a;color:white;font-family:sans-serif}
.center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
#x{font-size:72px;font-weight:900}
button{width:80%;height:60px;font-size:20px;border:none;border-radius:16px}
.start{background:#0098ea}
.take{background:#0ecb81}
</style>
</head>
<body>
<div class="center">
<div id="x">1.00x</div>
<p id="state">–û–∂–∏–¥–∞–Ω–∏–µ</p>
<button id="btn" class="start" onclick="action()">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

let x=1.0, fly=false, loop;

function action(){
  const btn=document.getElementById("btn");
  if(!fly){
    fly=true; x=1.0;
    btn.innerText="–ó–ê–ë–†–ê–¢–¨";
    btn.className="take";
    document.getElementById("state").innerText="–í –ü–û–õ–ï–¢–ï";
    start();
  } else {
    tg.showAlert("–í—ã–≤–æ–¥ –Ω–∞ "+x.toFixed(2)+"x");
    reset();
  }
}

function start(){
  let crash=(1.3+Math.random()*4).toFixed(2);
  loop=setInterval(()=>{
    x+=x*0.01;
    document.getElementById("x").innerText=x.toFixed(2)+"x";
    if(x>=crash){
      clearInterval(loop);
      document.getElementById("state").innerText="üí• CRASH";
      document.getElementById("btn").innerText="–°–ì–û–†–ï–õ–û";
      setTimeout(reset,2000);
    }
  },60);
}

function reset(){
  clearInterval(loop);
  fly=false;
  document.getElementById("x").innerText="1.00x";
  document.getElementById("state").innerText="–û–∂–∏–¥–∞–Ω–∏–µ";
  const btn=document.getElementById("btn");
  btn.innerText="–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É";
  btn.className="start";
}
</script>
</body>
</html>
"""

# ===== –ó–ê–ü–£–°–ö =====
async def main():
    asyncio.create_task(dp.start_polling())
    uvicorn.run(app, host="0.0.0.0", port=8000)

if __name__ == "__main__":
    asyncio.run(main())

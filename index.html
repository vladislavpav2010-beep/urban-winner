import logging
import aiosqlite
import asyncio
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–ò–ó_BOTFATHER"
ADMIN_ID = 123456789 # –¢–≤–æ–π ID
WEBAPP_URL = "https://—Ç–≤–æ–π-—Å–∞–π—Ç-—Å-–∏–≥—Ä–æ–π.vercel.app" # –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–≤–æ—é –∏–≥—Ä—É

logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
async def init_db():
    async with aiosqlite.connect("database.db") as db:
        await db.execute("""
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                balance REAL DEFAULT 112.97,
                refs_count INTEGER DEFAULT 0,
                invited_by INTEGER
            )
        """)
        await db.commit()

# --- –ö–ù–û–ü–ö–ò ---
def main_kb():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(types.KeyboardButton("üöÄ –ò–≥—Ä–∞—Ç—å", web_app=WebAppInfo(url=WEBAPP_URL)))
    kb.add(types.KeyboardButton("üíé –ë–∞–ª–∞–Ω—Å"), types.KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"))
    kb.add(types.KeyboardButton("üèÜ –¢–æ–ø"))
    return kb

# --- –ö–û–ú–ê–ù–î–´ ---
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    uid = message.from_user.id
    args = message.get_args()
    
    async with aiosqlite.connect("database.db") as db:
        async with db.execute("SELECT user_id FROM users WHERE user_id = ?", (uid,)) as cur:
            user = await cur.fetchone()
            
        if not user:
            inviter = int(args) if args and args.isdigit() and int(args) != uid else None
            await db.execute("INSERT INTO users (user_id, invited_by) VALUES (?, ?)", (uid, inviter))
            if inviter:
                await db.execute("UPDATE users SET balance = balance + 5.0, refs_count = refs_count + 1 WHERE user_id = ?", (inviter,))
                try: await bot.send_message(inviter, "üîî +1 —Ä–µ—Ñ–µ—Ä–∞–ª! –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 5.0 TON")
                except: pass
            await db.commit()

    await message.answer(f"üöÄ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Crash!</b>\n\n–¢–≤–æ–π –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 112.97 TON", reply_markup=main_kb())

@dp.message_handler(lambda m: m.text == "üíé –ë–∞–ª–∞–Ω—Å")
async def bal(message: types.Message):
    async with aiosqlite.connect("database.db") as db:
        async with db.execute("SELECT balance FROM users WHERE user_id = ?", (message.from_user.id,)) as cur:
            res = await cur.fetchone()
            # –í—ã–≤–æ–¥–∏–º –±–∞–ª–∞–Ω—Å –∫–∞–∫ –Ω–∞ —Ç–≤–æ–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–µ
            await message.answer(f"üíé <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {res[0]:.2f} TON")

@dp.message_handler(lambda m: m.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def profile(message: types.Message):
    uid = message.from_user.id
    async with aiosqlite.connect("database.db") as db:
        async with db.execute("SELECT balance, refs_count FROM users WHERE user_id = ?", (uid,)) as cur:
            row = await cur.fetchone()
            
    # –°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
    ref_link = f"https://t.me/{(await bot.get_me()).username}?start={uid}"
    
    text = (
        f"üë§ <b>–ü—Ä–æ—Ñ–∏–ª—å:</b>\n"
        f"ID: <code>{uid}</code>\n"
        f"–ë–∞–ª–∞–Ω—Å: <b>{row[0]:.2f} TON</b>\n"
        f"–†–µ—Ñ–µ—Ä–∞–ª–æ–≤: <b>{row[1]}</b>\n\n"
        f"üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –¥—Ä—É–∑–µ–π:\n<code>{ref_link}</code>"
    )
    await message.answer(text)

if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.run_until_complete(init_db())
    executor.start_polling(dp, skip_updates=True)

import telebot
from telebot import types

TOKEN = '8428729370:AAFlWc5jr4w1fjSMTctjhaGTQOg0-ow3on4'
bot = telebot.TeleBot(TOKEN)

# Mock user data (In a real app, use a database)
user = {"bal": 0.0, "lvl": 1}

@bot.callback_query_handler(func=lambda call: True)
def logic(call):
    if call.data == "dep":
        # Create a button to pay with Telegram Stars (XTR)
        kb = types.InlineKeyboardMarkup()
        kb.add(types.InlineKeyboardButton("‚≠ê –ü–æ–ø–æ–ª–Ω–∏—Ç—å (35 Stars)", callback_data="buy_stars"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="main"))
        
        bot.edit_message_caption(
            "üíé **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞**\n\n35 ‚≠ê = 0.1 TON",
            call.message.chat.id,
            call.message.message_id,
            reply_markup=kb,
            parse_mode="HTML"
        )

    elif call.data == "buy_stars":
        # Generate the invoice for Telegram Stars
        prices = [types.LabeledPrice(label="35 Stars", amount=35)]
        
        bot.send_invoice(
            call.message.chat.id,
            title="–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞",
            description="–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ 0.1 TON –Ω–∞ –∏–≥—Ä–æ–≤–æ–π –±–∞–ª–∞–Ω—Å",
            invoice_payload="refill_01_ton",
            provider_token="", # Must be empty for Telegram Stars
            currency="XTR",    # Currency code for Stars
            prices=prices,
            start_parameter="refill"
        )

# --- PAYMENT PROCESSING ---

@bot.pre_checkout_query_handler(func=lambda query: True)
def checkout(pre_checkout_query):
    # Confirm readiness to accept payment
    bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)

@bot.message_handler(content_types=['successful_payment'])
def got_payment(m):
    # If payment is successful, update balance
    user['bal'] += 0.1
    bot.send_message(
        m.chat.id,
        f"‚úÖ **–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!**\n–ó–∞—á–∏—Å–ª–µ–Ω–æ: 0.1 TON\n–¢–≤–æ–π –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {user['bal']} TON",
        parse_mode="HTML"
    )

bot.infinity_polling()


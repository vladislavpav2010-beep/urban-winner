<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TON ROLLS PRO - POTATO SERVER EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ==========================================================================
        1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï (UI/UX)
        ==========================================================================
        */
        :root {
            --bg-dark: #000000;
            --bg-card: #111111;
            --bg-item: #1c1c1e;
            --accent-blue: #0088cc;
            --accent-gold: #f7a809;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
            --success: #34c759;
            --error: #ff3b30;
            --stars: #ffb100;
            --font-main: 'Manrope', sans-serif;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* ==========================================================================
        2. –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ (HEADER)
        ==========================================================================
        */
        .header {
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 0.5px solid #222;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-text {
            font-weight: 800;
            font-size: 20px;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--accent-gold);
        }

        .balance-badge {
            background: var(--bg-item);
            padding: 6px 12px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #333;
            transition: transform 0.2s;
        }

        .balance-badge:active { transform: scale(0.95); }

        .balance-badge img { width: 18px; height: 18px; }

        .balance-val { font-weight: 700; font-size: 15px; }

        /* ==========================================================================
        3. –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø
        ==========================================================================
        */
        .main-container {
            height: 100vh;
            padding-top: 64px;
            padding-bottom: calc(80px + var(--safe-area-bottom));
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .screen { display: none; width: 100%; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: calc(75px + var(--safe-area-bottom));
            background: #0a0a0a;
            border-top: 0.5px solid #222;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #555;
            text-decoration: none;
            cursor: pointer;
            transition: 0.3s;
        }

        .nav-item.active { color: var(--accent-gold); }

        .nav-item svg { width: 26px; height: 26px; fill: currentColor; }
        .nav-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; }

        /* ==========================================================================
        4. –ò–ì–†–û–í–ê–Ø –ó–û–ù–ê (WHEEL & BETS)
        ==========================================================================
        */
        .game-header {
            text-align: center;
            padding: 20px 0;
        }

        .jackpot-info {
            background: rgba(255, 255, 255, 0.05);
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 50px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .jackpot-label { font-size: 12px; color: var(--text-dim); margin-right: 8px; }
        .jackpot-amount { font-weight: 800; color: var(--text-main); }

        .wheel-wrapper {
            position: relative;
            width: 340px;
            height: 340px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .wheel-indicator {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }

        .wheel-center-hub {
            position: absolute;
            width: 84px;
            height: 84px;
            background: #000;
            border-radius: 50%;
            border: 4px solid #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .timer-val { font-size: 26px; font-weight: 800; color: #fff; line-height: 1; }
        .timer-desc { font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-top: 4px; }

        /* –°–¢–ê–í–ö–ò */
        .bet-interface { padding: 20px; }
        
        .input-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #222;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .currency-icon { width: 32px; height: 32px; }

        .amount-input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 28px;
            font-weight: 800;
            width: 100%;
            font-family: var(--font-main);
        }

        .bet-button {
            width: 100%;
            background: var(--accent-gold);
            color: #000;
            border: none;
            padding: 18px;
            border-radius: 18px;
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 15px rgba(247, 168, 9, 0.3);
        }

        .bet-button:active { transform: scale(0.97); }
        .bet-button:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* –°–ü–ò–°–û–ö –ò–ì–†–û–ö–û–í */
        .players-header {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dim);
        }

        .players-container { padding: 0 16px; }

        .player-card {
            background: var(--bg-card);
            margin-bottom: 8px;
            padding: 12px 16px;
            border-radius: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--accent-blue);
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn { from { transform: translateX(30px); opacity: 0; } }

        .player-info { display: flex; align-items: center; gap: 12px; }
        .player-ava { 
            width: 48px; height: 48px; 
            border-radius: 14px; 
            object-fit: cover; 
            border: 2px solid #222; 
        }

        .player-meta { display: flex; flex-direction: column; }
        .player-name { font-weight: 700; font-size: 15px; }
        .player-chance { font-size: 11px; color: var(--accent-gold); font-weight: 800; margin-top: 2px; }

        .player-bet-val { text-align: right; font-weight: 800; font-size: 16px; }
        .player-bet-val span { display: block; font-size: 10px; color: var(--text-dim); font-weight: 400; }

        /* ==========================================================================
        5. –ß–ê–¢ –ò –ë–û–¢–´ (REAL-TIME CHAT)
        ==========================================================================
        */
        .chat-view { height: 100%; display: flex; flex-direction: column; }
        .chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }

        .chat-msg { display: flex; gap: 12px; align-items: flex-start; max-width: 85%; }
        .chat-msg.me { align-self: flex-end; flex-direction: row-reverse; }

        .chat-msg-content {
            background: var(--bg-item);
            padding: 12px 16px;
            border-radius: 4px 18px 18px 18px;
            position: relative;
        }
        .chat-msg.me .chat-msg-content {
            background: var(--accent-blue);
            border-radius: 18px 18px 4px 18px;
        }

        .chat-sender { font-size: 12px; font-weight: 800; color: var(--accent-blue); margin-bottom: 4px; }
        .chat-msg.me .chat-sender { display: none; }
        .chat-text { font-size: 14px; line-height: 1.4; color: #fff; }

        .chat-input-area {
            padding: 16px;
            background: #000;
            border-top: 1px solid #222;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-field {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 12px 16px;
            color: #fff;
            font-family: inherit;
        }

        /* ==========================================================================
        6. –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê (WIN, STARS, GIFTS)
        ==========================================================================
        */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .modal {
            width: 90%;
            max-width: 380px;
            background: var(--bg-card);
            border-radius: 32px;
            padding: 32px 24px;
            text-align: center;
            border: 1px solid #333;
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } }

        .win-avatar-big {
            width: 120px; height: 120px;
            border-radius: 40px;
            border: 5px solid var(--accent-gold);
            margin-bottom: 15px;
            box-shadow: 0 0 30px rgba(247, 168, 9, 0.4);
        }

        .stars-icon-big { width: 80px; margin-bottom: 20px; }

        .btn-confirm-stars {
            width: 100%;
            background: var(--accent-blue);
            color: #fff;
            padding: 18px;
            border-radius: 18px;
            font-weight: 800;
            border: none;
            margin-top: 20px;
            font-size: 16px;
        }

        /* GIFTS DISPLAY */
        .gift-pills {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .gift-pill {
            background: #1a1a1a;
            padding: 8px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #333;
        }

        .gift-pill img { width: 20px; height: 20px; }
        .gift-pill span { font-size: 12px; font-weight: 700; color: var(--accent-gold); }

    </style>
</head>
<body>

    <header class="header">
        <div class="logo-section">
            <div class="logo-text">TON<span>ROLLS</span></div>
        </div>
        <div class="balance-badge" onclick="core.showStarsModal()">
            <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png">
            <span class="balance-val" id="user-balance">500.00</span>
        </div>
    </header>

    <main class="main-container">
        
        <section id="screen-pvp" class="screen active">
            <div class="game-header">
                <div class="jackpot-info">
                    <span class="jackpot-label">–ë–ê–ù–ö –†–ê–£–ù–î–ê:</span>
                    <span class="jackpot-amount" id="round-bank">0.00 TON</span>
                </div>
                
                <div class="wheel-wrapper">
                    <svg class="wheel-indicator" width="32" height="32" viewBox="0 0 24 24">
                        <path fill="white" d="M12 21l-12-18h24z"/>
                    </svg>
                    <canvas id="gameCanvas" width="800" height="800"></canvas>
                    <div class="wheel-center-hub">
                        <div class="timer-val" id="main-timer">20</div>
                        <div class="timer-desc">–°–ï–ö</div>
                    </div>
                </div>
            </div>

            <div class="bet-interface">
                <div class="input-card">
                    <div class="input-row">
                        <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" class="currency-icon">
                        <input type="number" id="bet-amount" class="amount-input" value="10.00" step="1">
                    </div>
                    <button class="bet-button" id="place-bet-btn" onclick="core.handleBet()">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
                </div>
            </div>

            <div class="players-header">
                <span>–£–ß–ê–°–¢–ù–ò–ö–ò (<span id="player-count">0</span>)</span>
                <span>–®–ê–ù–°</span>
            </div>
            
            <div id="players-list" class="players-container">
                </div>
        </section>

        <section id="screen-chat" class="screen">
            <div class="chat-view">
                <div class="chat-history" id="chat-flow">
                    </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input-field" class="chat-field" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button onclick="core.sendUserChat()" style="background:none; border:none; color:var(--accent-blue); font-weight:900;">–û–¢–ü–†–ê–í–ò–¢–¨</button>
                </div>
            </div>
        </section>

        <section id="screen-profile" class="screen">
            <div style="padding: 30px 20px; text-align: center;">
                <img src="https://ui-avatars.com/api/?name=User&background=0088cc&color=fff" style="width:100px; border-radius:30px; border:3px solid var(--accent-gold);">
                <h2 style="margin: 15px 0 5px 0;">@Crypto_King</h2>
                <p style="color: var(--text-dim); font-size: 14px;">–°—Ç–∞—Ç—É—Å: High Roller</p>
                
                <div style="margin-top:40px; background:var(--bg-card); border-radius:24px; padding:20px; text-align:left;">
                    <h3 style="margin-bottom:15px; font-size:16px;">–ú–û–ò NFT –ü–û–î–ê–†–ö–ò (GIFTS)</h3>
                    <div id="my-inventory" class="gift-pills">
                        <div class="gift-pill"><img src="https://imagedelivery.net/9sCnq8t69re_S97W87s69w/f1b88e0b-5e4c-473d-9d4e-6e467d5e6e00/public"> <span>Jester Hat #1587</span></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="core.switchTab('pvp', this)">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 7h2v5.33l4.24 2.52-1.02 1.68-5.22-3.13z"/></svg>
            <span>–†–£–õ–ï–¢–ö–ê</span>
        </div>
        <div class="nav-item" onclick="core.switchTab('chat', this)">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            <span>–ß–ê–¢</span>
        </div>
        <div class="nav-item" onclick="core.switchTab('profile', this)">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>–ü–†–û–§–ò–õ–¨</span>
        </div>
    </nav>

    <div class="overlay" id="modal-stars">
        <div class="modal">
            <img src="https://telegram.org/img/t_logo.png" class="stars-icon-big">
            <h2>–ü–æ–∫—É–ø–∫–∞ Stars</h2>
            <p style="color: var(--text-dim); font-size: 14px;">–•–æ—Ç–∏—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ Rolls –Ω–∞ <b>1,500 –∑–≤—ë–∑–¥</b>?</p>
            <button class="btn-confirm-stars" onclick="core.confirmStars()">–ö—É–ø–∏—Ç—å –∑–∞ ‚òÖ 1,500</button>
            <div style="margin-top:15px; font-size:12px; color:#555; cursor:pointer;" onclick="core.closeModals()">–û–¢–ú–ï–ù–ê</div>
        </div>
    </div>

    <div class="overlay" id="modal-win">
        <div class="modal">
            <h1 style="color: var(--accent-gold); font-size: 32px; margin:0;">–ü–û–ë–ï–î–ê!</h1>
            <img id="winner-img" src="" class="win-avatar-big">
            <h2 id="winner-name">@User</h2>
            <div style="font-size: 28px; font-weight: 900; color: #fff;" id="winner-amount">0.00 TON</div>
            
            <div class="gift-pills" id="win-gift-list">
                </div>
            
            <button class="bet-button" style="margin-top:25px;" onclick="core.closeModals()">–ó–ê–ë–†–ê–¢–¨ –í–´–ò–ì–†–´–®</button>
        </div>
    </div>

<script>
/**
 * ============================================================================
 * 7. –Ø–î–†–û –î–í–ò–ñ–ö–ê (GAME ENGINE) - POTATO MULTIPLIER LOGIC
 * ============================================================================
 */

class RollsEngine {
    constructor() {
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        this.balance = 500.00;
        this.players = [];
        this.gameState = 'WAITING'; // WAITING, SPINNING, SHOW_WINNER
        this.timer = 20;
        this.currentRotation = 0;
        
        // Canvas Setup
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        // –î–∞–Ω–Ω—ã–µ –±–æ—Ç–æ–≤
        this.botDatabase = [
            { name: "@LuckyWhale", ava: "https://ui-avatars.com/api/?name=LW&background=random" },
            { name: "@Ton_Master", ava: "https://ui-avatars.com/api/?name=TM&background=random" },
            { name: "@PepeInvestor", ava: "https://ui-avatars.com/api/?name=PI&background=33cc33&color=fff" },
            { name: "@RichCat", ava: "https://ui-avatars.com/api/?name=RC&background=random" },
            { name: "@BullMarket", ava: "https://ui-avatars.com/api/?name=BM&background=random" }
        ];

        this.init();
    }

    init() {
        this.updateBalanceUI();
        this.startLobbyTimer();
        this.simulateBots();
        this.renderLoop();
        
        // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
        this.addChatMessage("System", "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TON ROLLS! –°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥.");
    }

    updateBalanceUI() {
        document.getElementById('user-balance').textContent = this.balance.toFixed(2);
    }

    // --- –õ–û–ì–ò–ö–ê –¢–ê–ô–ú–ï–†–ê –ò –†–ê–£–ù–î–û–í ---
    startLobbyTimer() {
        this.lobbyInterval = setInterval(() => {
            if (this.gameState !== 'WAITING') return;
            
            this.timer--;
            document.getElementById('main-timer').textContent = this.timer;
            
            if (this.timer <= 0) {
                if (this.players.length < 2) {
                    this.timer = 10; // –ñ–¥–µ–º –¥–æ–ª—å—à–µ, –µ—Å–ª–∏ –º–∞–ª–æ –∏–≥—Ä–æ–∫–æ–≤
                } else {
                    this.startRotation();
                }
            }
        }, 1000);
    }

    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ò–ì–†–û–ö–ê (–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†) ---
    addPlayer(name, amount, ava, isMe = false) {
        const colors = ['#0088cc', '#f7a809', '#34c759', '#ff3b30', '#af52de', '#ff9500'];
        const player = {
            name,
            amount: parseFloat(amount),
            ava,
            isMe,
            color: colors[this.players.length % colors.length],
            imgObj: new Image()
        };
        player.imgObj.src = ava;
        
        this.players.push(player);
        this.updateRoundStats();
        this.drawWheel();
        this.playTick();
    }

    updateRoundStats() {
        const total = this.players.reduce((sum, p) => sum + p.amount, 0);
        document.getElementById('round-bank').textContent = total.toFixed(2) + " TON";
        document.getElementById('player-count').textContent = this.players.length;
        
        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞
        const list = document.getElementById('players-list');
        list.innerHTML = this.players.map(p => {
            const chance = ((p.amount / total) * 100).toFixed(1);
            return `
                <div class="player-card" style="border-left-color: ${p.color}">
                    <div class="player-info">
                        <img src="${p.ava}" class="player-ava">
                        <div class="player-meta">
                            <span class="player-name">${p.name}</span>
                            <span class="player-chance">${chance}% –®–ê–ù–°</span>
                        </div>
                    </div>
                    <div class="player-bet-val">
                        ${p.amount.toFixed(2)} TON
                        <span>${p.isMe ? '–í–ê–®–ê –°–¢–ê–í–ö–ê' : '–ò–ì–†–û–ö'}</span>
                    </div>
                </div>
            `;
        }).reverse().join('');
    }

    // --- –û–¢–†–ò–°–û–í–ö–ê –ö–û–õ–ï–°–ê (CANVAS) ---
    drawWheel() {
        const ctx = this.ctx;
        const w = this.canvas.width;
        const r = w / 2;
        ctx.clearRect(0, 0, w, w);

        if (this.players.length === 0) {
            ctx.beginPath();
            ctx.arc(r, r, r - 40, 0, Math.PI * 2);
            ctx.fillStyle = '#111';
            ctx.fill();
            return;
        }

        let total = this.players.reduce((sum, p) => sum + p.amount, 0);
        let startAngle = 0;

        this.players.forEach(p => {
            const sliceAngle = (p.amount / total) * Math.PI * 2;
            
            // –°–µ–∫—Ç–æ—Ä
            ctx.beginPath();
            ctx.moveTo(r, r);
            ctx.arc(r, r, r - 20, startAngle, startAngle + sliceAngle);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 8;
            ctx.stroke();

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ç–æ—Ä–∞ (–∫–∞–∫ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ)
            if (sliceAngle > 0.15) {
                ctx.save();
                ctx.translate(r, r);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.translate(r * 0.75, 0);
                ctx.rotate(-(startAngle + sliceAngle / 2));
                
                // –†–∞–º–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
                ctx.beginPath();
                ctx.arc(0, 0, 44, 0, Math.PI * 2);
                ctx.fillStyle = '#000';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.clip();
                
                if (p.imgObj.complete) {
                    ctx.drawImage(p.imgObj, -44, -44, 88, 88);
                }
                ctx.restore();
            }

            startAngle += sliceAngle;
        });
    }

    // --- –õ–û–ì–ò–ö–ê –í–†–ê–©–ï–ù–ò–Ø (POTATO MULTIPLIER) ---
    startRotation() {
        this.gameState = 'SPINNING';
        document.getElementById('place-bet-btn').disabled = true;
        
        // 1. –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∑–∞—Ä–∞–Ω–µ–µ (Server Side Simulation)
        const total = this.players.reduce((sum, p) => sum + p.amount, 0);
        const winTicket = Math.random() * total;
        let accumulator = 0;
        let winner = this.players[0];

        for (let p of this.players) {
            accumulator += p.amount;
            if (winTicket <= accumulator) {
                winner = p;
                break;
            }
        }

        // 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É–≥–æ–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        const winnerIndex = this.players.indexOf(winner);
        let stopAngleDeg = 0;
        let preAcc = 0;
        for (let i = 0; i < winnerIndex; i++) preAcc += this.players[i].amount;
        
        const winSliceSize = (winner.amount / total) * 360;
        const winStartAngle = (preAcc / total) * 360;
        
        // –£–≥–æ–ª, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ —Å–µ–∫—Ç–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (—Å —É—á–µ—Ç–æ–º –∏–Ω–≤–µ—Ä—Å–∏–∏ Canvas)
        const targetAngle = 360 - (winStartAngle + Math.random() * winSliceSize);
        const extraSpins = 360 * 8; // 8 –ø–æ–ª–Ω—ã—Ö –∫—Ä—É–≥–æ–≤
        const finalRotation = extraSpins + targetAngle;

        this.animateWheel(finalRotation, winner, total);
    }

    animateWheel(target, winner, total) {
        let currentRotation = 0;
        let velocity = 15;
        const startTime = Date.now();

        const animate = () => {
            currentRotation += velocity;
            this.currentRotation = currentRotation;
            this.canvas.style.transform = `rotate(${currentRotation - 90}deg)`;

            // –§–∏–∑–∏–∫–∞ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
            if (target - currentRotation < 1000) {
                velocity *= 0.988;
            }
            if (velocity < 0.2) velocity = 0.2;

            if (currentRotation < target) {
                requestAnimationFrame(animate);
            } else {
                this.finishRound(winner, total);
            }
        };
        animate();
    }

    finishRound(winner, total) {
        this.gameState = 'SHOW_WINNER';
        const winModal = document.getElementById('modal-win');
        const prize = (total * 0.95).toFixed(2); // 5% fee
        
        document.getElementById('winner-img').src = winner.ava;
        document.getElementById('winner-name').textContent = winner.name;
        document.getElementById('winner-amount').textContent = prize + " TON";
        
        // –î–æ–ø. –ø–æ–¥–∞—Ä–∫–∏ (Gifts)
        const giftList = document.getElementById('win-gift-list');
        giftList.innerHTML = `
            <div class="gift-pill"><img src="https://imagedelivery.net/9sCnq8t69re_S97W87s69w/f1b88e0b-5e4c-473d-9d4e-6e467d5e6e00/public"> <span>Lol Pop</span></div>
            <div class="gift-pill"><img src="https://imagedelivery.net/9sCnq8t69re_S97W87s69w/f1b88e0b-5e4c-473d-9d4e-6e467d5e6e00/public"> <span>Bundle</span></div>
        `;

        winModal.style.display = 'flex';
        
        if (winner.isMe) {
            this.balance += parseFloat(prize);
            this.updateBalanceUI();
            this.addChatMessage("SYSTEM", "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ " + prize + " TON!");
        } else {
            this.addChatMessage("SYSTEM", `–†–∞—É–Ω–¥ –æ–∫–æ–Ω—á–µ–Ω. –ü–æ–±–µ–¥–∏–ª ${winner.name}`);
        }
    }

    // --- –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï ---
    handleBet() {
        const amt = parseFloat(document.getElementById('bet-amount').value);
        if (this.balance < amt) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
        
        this.balance -= amt;
        this.updateBalanceUI();
        this.addPlayer("@–í—ã", amt, "https://ui-avatars.com/api/?name=ME&background=0088cc&color=fff", true);
        this.addChatMessage("@–í—ã", "–ó–∞—à–µ–ª –Ω–∞ " + amt + " TON! –£–¥–∞—á–∏ –º–Ω–µ üöÄ");
    }

    sendUserChat() {
        const inp = document.getElementById('chat-input-field');
        if (!inp.value) return;
        this.addChatMessage("@–í—ã", inp.value);
        inp.value = '';
    }

    addChatMessage(user, text) {
        const flow = document.getElementById('chat-flow');
        const isMe = user === "@–í—ã";
        const msg = document.createElement('div');
        msg.className = `chat-msg ${isMe ? 'me' : ''}`;
        msg.innerHTML = `
            <div class="chat-msg-content">
                <div class="chat-sender">${user}</div>
                <div class="chat-text">${text}</div>
            </div>
        `;
        flow.appendChild(msg);
        flow.scrollTop = flow.scrollHeight;
    }

    // --- –°–ò–ú–£–õ–Ø–¶–ò–Ø –ë–û–¢–û–í (–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†) ---
    simulateBots() {
        setInterval(() => {
            if (this.gameState === 'WAITING' && this.players.length < 10) {
                if (Math.random() > 0.7) {
                    const bot = this.botDatabase[Math.floor(Math.random() * this.botDatabase.length)];
                    const bet = (Math.random() * 20 + 5).toFixed(1);
                    this.addPlayer(bot.name, bet, bot.ava);
                    
                    // –ë–æ—Ç —á—Ç–æ-—Ç–æ –ø–∏—à–µ—Ç
                    if (Math.random() > 0.6) {
                        const phrases = ["–í—Å–µ–º —É–¥–∞—á–∏!", "–ö—Ä—É—Ç–∏–º-–≤–µ—Ä—Ç–∏–º", "–ù–∞–¥–µ—é—Å—å –Ω–∞ –ø–æ–±–µ–¥—É", "–û–≥–æ, –∫–∞–∫–æ–π –±–∞–Ω–∫!", "TON üöÄüöÄüöÄ"];
                        this.addChatMessage(bot.name, phrases[Math.floor(Math.random() * phrases.length)]);
                    }
                }
            }
        }, 4000);
    }

    // --- –ò–ù–¢–ï–†–§–ï–ô–°–ù–´–ï –ú–ï–¢–û–î–´ ---
    switchTab(tab, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('screen-' + tab).classList.add('active');
        el.classList.add('active');
    }

    showStarsModal() { document.getElementById('modal-stars').style.display = 'flex'; }
    
    confirmStars() {
        this.balance += 150; // –ù–∞—á–∏—Å–ª–∏–º –∑–∞ 1500 –∑–≤–µ–∑–¥
        this.updateBalanceUI();
        alert("–û–ø–ª–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +150 TON");
        this.closeModals();
    }

    closeModals() {
        document.getElementById('modal-stars').style.display = 'none';
        document.getElementById('modal-win').style.display = 'none';
        
        if (this.gameState === 'SHOW_WINNER') {
            this.resetGame();
        }
    }

    resetGame() {
        this.players = [];
        this.gameState = 'WAITING';
        this.timer = 20;
        document.getElementById('place-bet-btn').disabled = false;
        document.getElementById('main-timer').textContent = "20";
        this.updateRoundStats();
        this.drawWheel();
        this.canvas.style.transform = `rotate(-90deg)`;
    }

    renderLoop() {
        this.drawWheel();
        requestAnimationFrame(() => this.renderLoop());
    }

    playTick() {
        // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç (—Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π)
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } catch(e) {}
    }
}

// –ó–∞–ø—É—Å–∫
const core = new RollsEngine();

</script>
</body>
</html>

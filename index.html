import sqlite3
import logging
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
logging.basicConfig(level=logging.INFO)

TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù"
ADMIN_ID = 123456789  # –¢–≤–æ–π ID

bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (–ª—É—á—à–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–ª)
def get_db():
    db = sqlite3.connect("users.db")
    return db, db.cursor()

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
conn, cursor = get_db()
cursor.execute("""
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    balance INTEGER DEFAULT 0,
    ref INTEGER
)
""")
conn.commit()

# –ú–µ–Ω—é
menu = ReplyKeyboardMarkup(resize_keyboard=True)
menu.add(KeyboardButton("üéÅ –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫"), KeyboardButton("üíé –ë–∞–ª–∞–Ω—Å"))

@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    user_id = message.from_user.id
    args = message.get_args() # –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ —Å—Å—ã–ª–∫–∏
    
    conn, cursor = get_db()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()

    if not user:
        ref_id = None
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞: –Ω–µ —Å–∞–º –ª–∏ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç —á–∏—Å–ª–æ–º
        if args and args.isdigit():
            ref_candidate = int(args)
            if ref_candidate != user_id:
                ref_id = ref_candidate

        cursor.execute("INSERT INTO users (user_id, balance, ref) VALUES (?, ?, ?)", (user_id, 0, ref_id))
        
        if ref_id:
            # –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—é
            cursor.execute("UPDATE users SET balance = balance + 1 WHERE user_id = ?", (ref_id,))
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            try:
                await bot.send_message(ref_id, "ü§ù –ü–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å! +1 üíé")
            except:
                pass
        conn.commit()

    await message.answer("üéÅ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã –≤ –±–∞–∑–µ.", reply_markup=menu)

@dp.message_handler(lambda m: m.text == "üíé –ë–∞–ª–∞–Ω—Å")
async def balance(message: types.Message):
    conn, cursor = get_db()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (message.from_user.id,))
    res = cursor.fetchone()
    bal = res[0] if res else 0
    await message.answer(f"üíé –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: {bal}")

@dp.message_handler(lambda m: m.text == "üéÅ –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫")
async def gift(message: types.Message):
    conn, cursor = get_db()
    cursor.execute("UPDATE users SET balance = balance + 1 WHERE user_id = ?", (message.from_user.id,))
    conn.commit()
    await message.answer("üéâ –¢—ã –ø–æ–ª—É—á–∏–ª +1 –ø–æ–¥–∞—Ä–æ–∫!")

@dp.message_handler(commands=["users"])
async def users_count(message: types.Message):
    if message.from_user.id == ADMIN_ID:
        conn, cursor = get_db()
        cursor.execute("SELECT COUNT(*) FROM users")
        count = cursor.fetchone()[0]
        await message.answer(f"üë• –í—Å–µ–≥–æ –≤ –±–∞–∑–µ: {count}")

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)

import logging, asyncio, sqlite3, uvicorn, random
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

TOKEN = "7715603882:AAEeHI6FgAgoLI_BFFEtlDHUwIECdH62AYI" 
WEBAPP_URL = "–í–°–¢–ê–í–¨_–°–°–´–õ–ö–£_–ò–ó_NGROK"

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

def init_db():
    with sqlite3.connect("wheel.db") as conn:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å 100.00 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        conn.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, balance REAL DEFAULT 100.00)")
        conn.commit()

@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("INSERT OR IGNORE INTO users (id) VALUES (?)", (m.from_user.id,))
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üé° –û—Ç–∫—Ä—ã—Ç—å PvP –ö–æ–ª–µ—Å–æ", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer(f"<b>üíé –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: 100.00 TON</b>", reply_markup=kb)

@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background: #0b0e11; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { display: flex; justify-content: space-around; padding: 15px; background: #161a1e; border-bottom: 1px solid #2b3139; }
        .tab { color: #848e9c; font-weight: bold; }
        .active { color: white; border-bottom: 2px solid #0098ea; }
        
        /* –ö–æ–ª–µ—Å–æ —Å –≥–∏—Ä–ª—è–Ω–¥–æ–π */
        .wheel-container { position: relative; width: 280px; height: 280px; margin: 20px auto; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; border: 6px solid #2b3139; background: #1e2329; transition: transform 5s cubic-bezier(0.1, 0, 0.2, 1); }
        .pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 20px solid white; z-index: 10; }
        .center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: #0b0e11; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 3px solid #2b3139; }

        /* –°—Ç–∞–≤–∫–∏ –∏ –º–µ–Ω—é */
        .bet-area { padding: 10px; display: flex; flex-direction: column; align-items: center; }
        input { background: #1e2329; border: 1px solid #2b3139; color: white; padding: 10px; border-radius: 8px; width: 80%; text-align: center; margin-bottom: 10px; }
        .btn-bet { background: #0098ea; color: white; border: none; padding: 12px; border-radius: 10px; width: 85%; font-weight: bold; cursor: pointer; }
        
        .footer { position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; background: #161a1e; padding: 15px 0; border-top: 1px solid #2b3139; }
        .foot-item { font-size: 12px; color: #848e9c; text-align: center; }
        .player-row { width: 90%; display: flex; justify-content: space-between; padding: 8px; background: #1e2329; margin: 3px; border-radius: 6px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="header"><div class="tab active">–ì–∏—Ñ—Ç—ã</div><div class="tab">–°—Ç–∏–∫–µ—Ä—ã</div></div>
    
    <div style="text-align:center; padding: 10px; color:#848e9c">–í–°–ï–ì–û: <span id="total" style="color:white">0.00</span> TON</div>

    <div class="wheel-container">
        <div class="pointer"></div>
        <div id="wheel"></div>
        <div class="center" id="status">–û–ñ–ò–î–ê–ù–ò–ï</div>
    </div>

    <div class="bet-area">
        <input type="number" id="betAmount" value="1.0" step="0.1">
        <button class="btn-bet" onclick="joinPvP()">–î–û–ë–ê–í–ò–¢–¨ –í PvP</button>
    </div>

    <div id="players" style="overflow-y: auto; flex-grow: 1; display:flex; flex-direction:column; align-items:center;"></div>

    <div class="footer">
        <div class="foot-item">‚öîÔ∏è –ü–≤–ü</div><div class="foot-item">üé° –°–æ–ª–æ</div><div class="foot-item">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div><div class="foot-item">üè™ –ú–∞–≥–∞–∑–∏–Ω</div><div class="foot-item">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        let balance = 100.00;
        let players = [];
        let isSpinning = false;

        function joinPvP() {
            if (isSpinning) return;
            const bet = parseFloat(document.getElementById('betAmount').value);
            if (bet > balance) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON!');
            
            balance -= bet;
            players = [{name: "–¢—ã", bet: bet, color: "#0098ea", avatar: "üë§"}];
            updateWheel();
            startTimer();
        }

        function startTimer() {
            let time = 15; // –¢–∞–π–º–µ—Ä –Ω–∞ 15 —Å–µ–∫
            const btn = document.querySelector('.btn-bet');
            btn.disabled = true;
            
            const timer = setInterval(() => {
                document.getElementById('status').innerHTML = `00:${time < 10 ? '0'+time : time}`;
                
                // –ë–æ—Ç—ã –∑–∞–ª–µ—Ç–∞—é—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                if (time == 12) addBot("Gusati", 0.5, "#f6465d");
                if (time == 8) addBot("Andre", 2.1, "#0ecb81");
                if (time == 3) addBot("NeverBye", 1.5, "#f0b90b");

                if (time <= 0) {
                    clearInterval(timer);
                    spin();
                }
                time--;
            }, 1000);
        }

        function addBot(name, bet, color) {
            players.push({name, bet, color, avatar: "ü§ñ"});
            updateWheel();
        }

        function updateWheel() {
            let total = players.reduce((s, p) => s + p.bet, 0);
            document.getElementById('total').innerText = total.toFixed(2);
            let grad = ""; let start = 0;
            let html = "";
            players.forEach(p => {
                let deg = (p.bet / total) * 360;
                grad += `${p.color} ${start}deg ${start+deg}deg, `;
                start += deg;
                html += `<div class="player-row"><span>${p.avatar} ${p.name}</span><b>${p.bet} TON</b></div>`;
            });
            document.getElementById('wheel').style.background = `conic-gradient(${grad.slice(0,-2)})`;
            document.getElementById('players').innerHTML = html;
        }

        function spin() {
            isSpinning = true;
            document.getElementById('status').innerText = "–ò–ì–†–ê";
            let deg = Math.floor(Math.random() * 3600) + 1800;
            document.getElementById('wheel').style.transform = `rotate(${deg}deg)`;
            setTimeout(() => {
                alert("–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω!");
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
            }, 5500);
        }
    </script>
</body>
</html>
    """

if __name__ == "__main__":
    init_db()
    from threading import Thread
    Thread(target=lambda: executor.start_polling(dp, skip_updates=True)).start()
    uvicorn.run(app, host="0.0.0.0", port=8000)

import uvicorn
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
TOKEN = "7715603882:AAEeHI6FgAgoLI_BFFEtlDHUwIECdH62AYI" 
WEBAPP_URL = "–í–°–¢–ê–í–¨_–°–°–´–õ–ö–£_–ò–ó_NGROK" # –°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer(f"<b>üíé –ë–∞–ª–∞–Ω—Å: 100.00 TON</b>\n–£–¥–∞—á–∏!", reply_markup=kb)

# –ß–∏—Å—Ç—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–µ–∑ –∫–æ–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg:#07080a; --blue:#0098ea; --green:#0ecb81; --red:#f6465d; --text:#707a8a; }
        * { box-sizing:border-box; font-family: sans-serif; margin:0; padding:0; color:white; outline:none; }
        body { background:var(--bg); overflow:hidden; display:flex; flex-direction:column; height:100vh; }

        /* –í–µ—Ä—Ö: –æ–Ω–ª–∞–π–Ω –∏ –±–∞–ª–∞–Ω—Å TON */
        .header { display:flex; justify-content:space-between; padding:15px; align-items:center; }
        .balance { background:#1e2329; padding:6px 15px; border-radius:50px; font-weight:800; font-size:14px; display:flex; align-items:center; gap:6px; }
        .plus { background:white; color:black; width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ: –º–Ω–æ–∂–∏—Ç–µ–ª—å */
        .game-view { flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .multiplier { font-size:90px; font-weight:900; }
        .status { color:var(--text); font-size:12px; margin-top:10px; text-transform:uppercase; letter-spacing:1px; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { background:#0c0d10; padding:20px; border-radius:24px 24px 0 0; }
        .tabs { display:flex; background:#1e2329; border-radius:12px; padding:4px; margin-bottom:15px; }
        .tab { flex:1; text-align:center; padding:10px; font-size:11px; font-weight:bold; color:var(--text); border-radius:8px; }
        .tab.active { background:#2a2e35; color:white; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞: –°—É–º–º–∞ –∏ –ê–≤—Ç–æ–≤—ã–≤–æ–¥ */
        .inputs { display:flex; gap:10px; margin-bottom:15px; }
        .field { flex:1; background:#1e2329; padding:10px; border-radius:12px; border:1px solid #2a2e35; }
        .field label { font-size:9px; color:var(--text); display:block; margin-bottom:4px; font-weight:bold; }
        input { background:transparent; border:none; font-size:18px; font-weight:bold; width:100%; color:white; }

        .btn-main { width:100%; height:58px; border-radius:18px; border:none; background:var(--blue); font-size:18px; font-weight:bold; transition: 0.2s; }
        .btn-main.take { background:var(--green); }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é: –°—Ç–∞–≤–∫–∏, –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å, –ü—Ä–æ—Ñ–∏–ª—å */
        .nav { display:flex; padding:12px 0; background:#0c0d10; border-top:1px solid #1a1d23; }
        .nav-i { flex:1; text-align:center; font-size:10px; color:var(--text); opacity:0.6; }
        .nav-i.active { color:var(--blue); opacity:1; }
    </style>
</head>
<body>
    <div class="header">
        <div style="color:var(--green); font-size:12px; font-weight:bold;">‚óè 158 –æ–Ω–ª–∞–π–Ω</div>
        <div class="balance">
            <span>100.00 <span style="color:var(--green)">TON</span></span>
            <div class="plus">+</div>
        </div>
    </div>

    <div class="game-view">
        <div class="multiplier" id="mult">1.00</div>
        <div class="status" id="state">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <div class="controls">
        <div class="tabs">
            <div class="tab active">–°–¢–ê–í–ö–ò</div>
            <div class="tab">–ò–ù–í–ï–ù–¢–ê–†–¨</div>
            <div class="tab">–ü–†–û–§–ò–õ–¨</div>
        </div>
        <div class="inputs">
            <div class="field"><label>–°–£–ú–ú–ê (TON)</label><input type="number" id="bet" value="10.0"></div>
            <div class="field"><label>–ê–í–¢–û–í–´–í–û–î</label><input type="number" id="auto" value="2.00"></div>
        </div>
        <button class="btn-main" id="main_btn" onclick="handleAction()">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
    </div>

    <div class="nav">
        <div class="nav-i">üèÜ<br>–¢–æ–ø</div>
        <div class="nav-i active">üöÄ<br>–ö—Ä–∞—à</div>
        <div class="nav-i">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        let x = 1.0, isFlying = false, loop, balance = 100.0;

        function handleAction() {
            const btn = document.getElementById('main_btn');
            if (!isFlying) {
                // –°—Ç–∞—Ä—Ç –ø–æ–ª–µ—Ç–∞
                isFlying = true;
                btn.innerText = "–ó–ê–ë–†–ê–¢–¨";
                btn.className = "btn-main take";
                document.getElementById('state').innerText = "–í –ü–û–õ–ï–¢–ï";
                startFlight();
            } else {
                // –ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à
                let win = (document.getElementById('bet').value * x).toFixed(2);
                tg.showAlert("–£—Å–ø–µ—Ö! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ " + win + " TON");
                resetGame();
            }
        }

        function startFlight() {
            let crashPoint = (1.2 + Math.random() * 4).toFixed(2);
            loop = setInterval(() => {
                x += x * 0.01;
                document.getElementById('mult').innerText = x.toFixed(2);
                
                // –ê–≤—Ç–æ–≤—ã–≤–æ–¥
                if (x >= document.getElementById('auto').value) {
                    handleAction();
                }

                if (x >= crashPoint) {
                    clearInterval(loop);
                    document.getElementById('mult').style.color = "var(--red)";
                    document.getElementById('state').innerText = "–í–ó–†–´–í";
                    document.getElementById('main_btn').innerText = "–°–ì–û–†–ï–õ–û";
                    document.getElementById('main_btn').className = "btn-main";
                    setTimeout(resetGame, 2000);
                }
            }, 60);
        }

        function resetGame() {
            clearInterval(loop);
            x = 1.0; isFlying = false;
            document.getElementById('mult').innerText = "1.00";
            document.getElementById('mult').style.color = "white";
            document.getElementById('state').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ...";
            document.getElementById('main_btn').innerText = "–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É";
            document.getElementById('main_btn').className = "btn-main";
        }
    </script>
</body>
</html>
"""

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)

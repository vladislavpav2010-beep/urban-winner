import logging, sqlite3, uvicorn, random
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

# --- –¢–í–û–ò –ù–ê–°–¢–†–û–ô–ö–ò ---
TOKEN = "7715603882:AAEeHI6FgAgoLI_BFFEtlDHUwIECdH62AYI" 
WEBAPP_URL = "–í–°–¢–ê–í–¨_–°–°–´–õ–ö–£_–ò–ó_NGROK" # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å https://

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

def init_db():
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, balance REAL DEFAULT 100.00)")
        conn.commit()

@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("INSERT OR IGNORE INTO users (id) VALUES (?)", (m.from_user.id,))
    kb = types.InlineKeyboardMarkup()
    # –ó–∞–º–µ–Ω–∏–ª —Ä–∞–∫–µ—Ç–∫—É –Ω–∞ –∫–æ–ª–µ—Å–æ üé°
    kb.add(types.InlineKeyboardButton("üé° –ò–≥—Ä–∞—Ç—å –≤ PvP", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer("<b>üíé –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: 100.00 TON</b>\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É!", reply_markup=kb)

# –ì–õ–ê–í–ù–û–ï: –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        .header { width: 100%; display: flex; justify-content: space-around; padding: 15px 0; background: #161a1e; border-bottom: 1px solid #2b3139; font-size: 14px; font-weight: bold; }
        .active-tab { color: white; border-bottom: 2px solid #0098ea; padding-bottom: 5px; }
        .bal-top { margin: 15px 0; font-size: 18px; font-weight: bold; color: #f0b90b; }
        
        .wheel-box { position: relative; width: 280px; height: 280px; margin-top: 10px; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; border: 8px solid #2b3139; background: #1e2329; transition: transform 5s cubic-bezier(0.1, 0, 0.2, 1); }
        .arrow { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #fff; z-index: 5; }
        .timer-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: #0b0e11; border-radius: 50%; border: 3px solid #2b3139; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }

        .ui-bet { width: 90%; margin-top: 20px; z-index: 20; }
        input { width: 100%; background: #1e2329; border: 1px solid #2b3139; color: white; padding: 12px; border-radius: 10px; text-align: center; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-play { width: 100%; background: #0098ea; border: none; padding: 15px; color: white; border-radius: 12px; font-weight: bold; font-size: 16px; }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é –ë–ï–ó –¢–ï–ö–°–¢–ê –ö–û–î–ê */
        .footer { position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; padding: 15px 0; background: #161a1e; border-top: 1px solid #2b3139; z-index: 100; }
        .f-btn { font-size: 11px; color: #848e9c; text-align: center; }
        .f-btn.active { color: #0098ea; }
    </style>
</head>
<body>
    <div class="header"><div class="active-tab">–ì–∏—Ñ—Ç—ã</div><div>–°—Ç–∏–∫–µ—Ä—ã</div></div>
    <div class="bal-top">100.00 TON</div>

    <div class="wheel-box">
        <div class="arrow"></div>
        <div id="wheel"></div>
        <div class="timer-center" id="status">00:15</div>
    </div>

    <div class="ui-bet" id="betBlock">
        <input type="number" id="bet" value="1.0">
        <button class="btn-play" onclick="start()">–î–û–ë–ê–í–ò–¢–¨ –í PvP</button>
    </div>

    <div class="footer">
        <div class="f-btn active">‚öîÔ∏è –ü–≤–ü</div><div class="f-btn">üé° –°–æ–ª–æ</div><div class="f-btn">üéí –ò–Ω–≤.</div><div class="f-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        let players = [];

        function start() {
            document.getElementById('betBlock').style.visibility = 'hidden';
            let time = 15;
            let timer = setInterval(() => {
                time--;
                document.getElementById('status').innerText = `00:${time < 10 ? '0'+time : time}`;
                
                // –ë–æ—Ç—ã —Å—Ç–∞–≤—è—Ç –ø–æ 0.10
                if(time == 12) addPlayer("#f6465d", 0.08);
                if(time == 8) addPlayer("#0ecb81", 0.10);
                if(time == 3) addPlayer("#f0b90b", 0.05);

                if(time <= 0) {
                    clearInterval(timer);
                    document.getElementById('status').innerText = "–ò–ì–†–ê";
                    let deg = 1800 + Math.floor(Math.random() * 3600);
                    document.getElementById('wheel').style.transform = `rotate(${deg}deg)`;
                }
            }, 1000);
        }

        function addPlayer(color, bet) {
            players.push({color, bet});
            let total = players.reduce((a, b) => a + b.bet, 0);
            let g = ""; let s = 0;
            players.forEach(p => {
                let d = (p.bet / total) * 360;
                g += `${p.color} ${s}deg ${s+d}deg, `;
                s += d;
            });
            document.getElementById('wheel').style.background = `conic-gradient(${g.slice(0,-2)})`;
        }
    </script>
</body>
</html>
"""

if __name__ == "__main__":
    init_db()
    from threading import Thread
    Thread(target=lambda: executor.start_polling(dp)).start()
    uvicorn.run(app, host="0.0.0.0", port=8000)

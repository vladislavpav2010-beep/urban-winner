import os, logging, asyncio, sqlite3, uvicorn
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù"
WEBAPP_URL = "https://—Ç–≤–æ—è-—Å—Å—ã–ª–∫–∞.ngrok-free.app"

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

# --- –ë–î (–ë–∞–ª–∞–Ω—Å –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–∞—Ö) ---
def init_db():
    conn = sqlite3.connect("wheel.db")
    conn.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, balance REAL DEFAULT 8.54)")
    conn.commit()
    conn.close()

@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(types.KeyboardButton("üé° –ö—Ä—É—Ç–∏—Ç—å –ö–æ–ª–µ—Å–æ", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer("<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã!</b>", reply_markup=kb)

# --- –ò–ù–¢–ï–†–§–ï–ô–° –ö–û–õ–ï–°–ê ---
@app.get("/", response_class=HTMLResponse)
async def game():
    return """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; }
        .header { display: flex; justify-content: space-around; padding: 20px; background: #161a1e; }
        
        /* –ö–æ–ª–µ—Å–æ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ 1000042178.jpg */
        .wheel-container { position: relative; margin: 50px auto; width: 300px; height: 300px; }
        #wheel { 
            width: 100%; height: 100%; border-radius: 50%; border: 5px solid #2b3139;
            background: conic-gradient(#0ecb81 0deg 120deg, #f6465d 120deg 240deg, #0098ea 240deg 360deg);
            transition: transform 4s cubic-bezier(0.1, 0, 0.2, 1);
            position: relative;
        }
        .pointer { 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 20px solid white; z-index: 10;
        }
        .center-timer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: black; width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;
        }

        .footer-menu { position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; background: #161a1e; padding: 15px 0; }
        .btn-spin { background: #0098ea; border: none; padding: 15px 40px; border-radius: 10px; color: white; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div>–ì–∏—Ñ—Ç—ã</div>
        <div>–°—Ç–∏–∫–µ—Ä—ã</div>
    </div>
    
    <div style="margin-top: 10px; color: #848e9c;">–í–°–ï–ì–û: 8.54 TON</div>

    <div class="wheel-container">
        <div class="pointer"></div>
        <div id="wheel"></div>
        <div class="center-timer" id="timer">00:00</div>
    </div>

    <button class="btn-spin" onclick="spin()">–î–û–ë–ê–í–ò–¢–¨ –í PvP</button>

    <div class="footer-menu">
        <div>–ü–≤–ü</div>
        <div>–°–æ–ª–æ</div>
        <div>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
        <div>–ú–∞–≥–∞–∑–∏–Ω</div>
        <div>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        function spin() {
            let wheel = document.getElementById('wheel');
            let randomDeg = Math.floor(Math.random() * 3600) + 720; // –ú–∏–Ω–∏–º—É–º 2 –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–∞
            wheel.style.transform = "rotate(" + randomDeg + "deg)";
            
            setTimeout(() => {
                alert("–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω!");
            }, 4000);
        }
    </script>
</body>
</html>
    """

if __name__ == "__main__":
    init_db()
    from threading import Thread
    Thread(target=lambda: executor.start_polling(dp, skip_updates=True)).start()
    uvicorn.run(app, host="0.0.0.0", port=8000)


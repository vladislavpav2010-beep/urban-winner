import logging
import asyncio
import sqlite3
import uvicorn
import random
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import WebAppInfo
from fastapi import FastAPI
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles

# --- –¢–í–û–ò –ù–ê–°–¢–†–û–ô–ö–ò ---
TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–ó–î–ï–°–¨" 
WEBAPP_URL = "https://—Ç–≤–æ—è-—Å—Å—ã–ª–∫–∞.ngrok-free.app"

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)
app = FastAPI()

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def init_db():
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, balance REAL DEFAULT 8.54)")
        conn.commit()

# --- –ë–û–¢ ---
@dp.message_handler(commands=['start'])
async def start(m: types.Message):
    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    with sqlite3.connect("wheel.db") as conn:
        conn.execute("INSERT OR IGNORE INTO users (id) VALUES (?)", (m.from_user.id,))
    
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(types.KeyboardButton("üé° –ö—Ä—É—Ç–∏—Ç—å (PvP)", web_app=WebAppInfo(url=WEBAPP_URL)))
    await m.answer("<b>üé∞ PvP –ö–æ–ª–µ—Å–æ –≥–æ—Ç–æ–≤–æ!</b>\n–ñ–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ—Ä–≤–∞—Ç—å—Å—è –≤ –∏–≥—Ä—É.", reply_markup=kb)

# --- API –î–õ–Ø –ò–ì–†–´ ---
@app.get("/api/bots")
async def get_bots():
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ –∫–∞–∫ –Ω–∞ –≤–∏–¥–µ–æ
    names = ["Gusati", "Andre", "NeverBye", "Enzu", "Nikita", "Ilya"]
    avatars = [
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob"
    ]
    
    bots = []
    # –î–æ–±–∞–≤–ª—è–µ–º 2-3 –±–æ—Ç–∞
    for _ in range(random.randint(2, 3)):
        bots.append({
            "name": random.choice(names),
            "avatar": random.choice(avatars),
            "bet": round(random.uniform(0.5, 5.0), 2),
            "color": random.choice(["#f6465d", "#0ecb81", "#0098ea", "#f0b90b"])
        })
    return {"bots": bots}

# --- –ò–ù–¢–ï–†–§–ï–ô–° (HTML/JS) ---
@app.get("/", response_class=HTMLResponse)
async def serve_game():
    return """
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #0b0e11; color: white; font-family: sans-serif; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ 1000042178.jpg */
        .top-bar { width: 100%; display: flex; justify-content: space-around; padding: 15px; background: #161a1e; font-weight: bold; }
        .tab { color: #848e9c; }
        .tab.active { color: white; border-bottom: 2px solid white; }

        /* –ö–æ–ª–µ—Å–æ */
        .wheel-wrap { position: relative; width: 320px; height: 320px; margin-top: 40px; }
        .wheel { 
            width: 100%; height: 100%; border-radius: 50%; border: 8px solid #2b3139;
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative; overflow: hidden;
        }
        
        /* –°—Ç—Ä–µ–ª–∫–∞ —Å–≤–µ—Ä—Ö—É */
        .pointer { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; 
            border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid white; 
            z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }

        /* –¢–∞–π–º–µ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ */
        .center-hub {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; background: #0b0e11; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 900; z-index: 5; border: 4px solid #2b3139;
        }

        /* –ö–Ω–æ–ø–∫–∞ */
        .btn-play {
            background: #f0b90b; color: black; border: none; padding: 15px 40px; 
            border-radius: 12px; font-size: 18px; font-weight: 900; margin-top: 50px; cursor: pointer;
            box-shadow: 0 4px 0 #c49607; width: 90%;
        }
        .btn-play:active { transform: translateY(2px); box-shadow: none; }

        /* –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ */
        .players-list { width: 90%; margin-top: 20px; }
        .player-row { display: flex; align-items: center; justify-content: space-between; background: #1e2329; padding: 10px; margin-bottom: 5px; border-radius: 8px; }
        .p-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        .p-info { display: flex; align-items: center; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="tab active">–ì–∏—Ñ—Ç—ã</div>
        <div class="tab">–°—Ç–∏–∫–µ—Ä—ã</div>
    </div>
    
    <div style="margin-top: 10px; font-size: 12px; color: #848e9c;">–ë–ê–ù–ö –ò–ì–†–´: <span id="total-pot" style="color:white; font-weight:bold;">0.00 TON</span></div>

    <div class="wheel-wrap">
        <div class="pointer"></div>
        <div class="wheel" id="wheel"></div>
        <div class="center-hub" id="timer">–ò–ì–†–ê</div>
    </div>

    <div class="players-list" id="p-list"></div>

    <button class="btn-play" onclick="startGame()">–í–û–ô–¢–ò –í PvP</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let spinning = false;

        async function startGame() {
            if (spinning) return;
            
            // 1. –ü–æ–ª—É—á–∞–µ–º –±–æ—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
            const res = await fetch('/api/bots');
            const data = await res.json();
            const bots = data.bots;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è (–¢—ã)
            bots.push({
                name: "–¢—ã", 
                avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=You", 
                bet: 5.0, 
                color: "#6f42c1" 
            });

            // 2. –†–∏—Å—É–µ–º —Å–µ–∫—Ç–æ—Ä–∞ –Ω–∞ –∫–æ–ª–µ—Å–µ (Conic Gradient)
            let gradientStr = "";
            let startDeg = 0;
            let totalBet = bots.reduce((sum, b) => sum + b.bet, 0);
            document.getElementById('total-pot').innerText = totalBet.toFixed(2) + " TON";

            let listHtml = "";
            
            bots.forEach((bot, index) => {
                let percent = (bot.bet / totalBet) * 100;
                let deg = (bot.bet / totalBet) * 360;
                
                // –°—Ç—Ä–æ–∏–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è CSS
                gradientStr += `${bot.color} ${startDeg}deg ${startDeg + deg}deg, `;
                startDeg += deg;

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –≤–Ω–∏–∑—É
                listHtml += `
                    <div class="player-row">
                        <div class="p-info"><img src="${bot.avatar}" class="p-avatar"> ${bot.name}</div>
                        <div>${bot.bet} TON</div>
                    </div>`;
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏
            gradientStr = gradientStr.slice(0, -2); // –£–±–∏—Ä–∞–µ–º –∑–∞–ø—è—Ç—É—é
            document.getElementById('wheel').style.background = `conic-gradient(${gradientStr})`;
            document.getElementById('p-list').innerHTML = listHtml;

            // 3. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ø–∏–Ω
            spinning = true;
            document.getElementById('timer').innerText = "SPIN";
            
            let randomDeg = Math.floor(Math.random() * 3600) + 1440; // –ú–∏–Ω–∏–º—É–º 4 –æ–±–æ—Ä–æ—Ç–∞
            document.getElementById('wheel').style.transform = `rotate(${randomDeg}deg)`;

            setTimeout(() => {
                spinning = false;
                tg.showPopup({title: '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!', message: '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (—ç—Ç–æ —Ç–µ—Å—Ç)'});
                document.getElementById('timer').innerText = "–ò–ì–†–ê";
            }, 5500);
        }
    </script>
</body>
</html>
    """

if __name__ == "__main__":
    init_db()
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –±–æ—Ç–∞, –∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º ‚Äî —Å–µ—Ä–≤–µ—Ä
    from threading import Thread
    Thread(target=lambda: executor.start_polling(dp, skip_updates=True)).start()
    uvicorn.run(app, host="0.0.0.0", port=8000)
